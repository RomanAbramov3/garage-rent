<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê—Ä–µ–Ω–¥–∞ –≥–∞—Ä–∞–∂–µ–π ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–ª–∞—Ç</title>

  <!-- –£–±–∏—Ä–∞–µ—Ç ‚Äúhtml‚Äù –∏–∫–æ–Ω–∫—É: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π favicon + –∏–∫–æ–Ω–∫–∞ –¥–ª—è iPhone -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%231a73e8'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3E‚ÇΩ%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%231a73e8'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='86' font-family='Arial' fill='white'%3E‚ÇΩ%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#1a73e8">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body {
      margin: 0;
      color:#111;
      background:
        radial-gradient(circle at 12px 12px, rgba(26,115,232,0.06) 1.2px, transparent 1.2px) 0 0/22px 22px,
        #f6f7fb;
    }

    .wrap { max-width: 1050px; margin: 0 auto; padding: 18px; position: relative; }

    /* Motivational sticker */
    .sticker {
      position: absolute;
      top: 14px;
      right: 14px;
      max-width: 260px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(26,115,232,.18);
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      font-style: italic;
      font-weight: 700;
      letter-spacing: .2px;
      color: rgba(25, 42, 68, .86);
      animation: breathe 5.5s ease-in-out infinite;
      user-select: none;
      pointer-events: none;
    }
    .sticker small { display:block; font-style: normal; font-weight: 650; opacity: .75; margin-top: 2px; }
    @keyframes breathe {
      0%   { opacity: .55; transform: translateY(0); }
      50%  { opacity: .95; transform: translateY(-1px); }
      100% { opacity: .55; transform: translateY(0); }
    }
    @media (max-width: 600px){
      .sticker { position: static; margin: 10px 0 12px; max-width: none; }
    }

    h1 { margin: 0 0 10px; font-size: 22px; }
    h2 { margin: 0 0 10px; font-size: 16px; }

    .grid { display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1.2fr .8fr; } }

    .card {
      background:#fff;
      border:1px solid #e6e8ef;
      border-radius:14px;
      padding:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }

    label { display:block; font-size: 12px; color:#555; margin: 10px 0 6px; }
    input, select, button, textarea {
      width:100%;
      box-sizing: border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #d7dbe6;
      background:#fff;
    }
    textarea { resize: vertical; min-height: 44px; }
    button { cursor:pointer; border:0; background:#1a73e8; color:#fff; font-weight:800; }
    button.secondary { background:#eef2ff; color:#1f2a44; border:1px solid #d7dbe6; }
    button.danger { background:#ffe9e9; color:#7a0610; border:1px solid #f5b5b5; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row > * { flex:1; min-width: 160px; }

    .muted { color:#666; font-size: 12px; }

    .status { display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px; border:1px solid #e6e8ef; font-size:12px; }
    .ok   { background:#eaf6ee; border-color:#bfe7cd; color:#0b7a34; }
    .bad  { background:#fdecec; border-color:#f7b4b4; color:#b42318; }
    .soon { background:#fff6e6; border-color:#ffe1a8; color:#8a5a00; }
    .neutral { background:#f1f5ff; border-color:#d7dbe6; color:#1f2a44; }

    .kpi { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .kpi .box { padding:12px; border-radius:12px; border:1px solid #e6e8ef; background:#fbfcff; }
    .kpi .name { font-size: 12px; color:#555; }
    .kpi .val { font-size: 18px; font-weight: 900; margin-top: 4px; }
    .val.good { color:#0b7a34; }
    .val.bad { color:#b42318; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #eef0f6; text-align:left; font-size: 13px; vertical-align: top; }
    th { font-size: 12px; color:#555; font-weight: 800; }

    .mini { font-size:12px; color:#666; margin-top:3px; }
    .actions { display:flex; gap:8px; flex-wrap: wrap; }
    .actions button { padding:8px 10px; border-radius:10px; }
    .nowrap { white-space: nowrap; }

    /* tabs */
    .tabs { display:flex; gap:8px; overflow:auto; padding-bottom: 6px; -webkit-overflow-scrolling: touch; }
    .tab {
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #e6e8ef;
      background:#fbfcff;
      font-size:13px;
      color:#1f2a44;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease;
    }
    .tab.active { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .tab:active { transform: translateY(1px); }

    /* Report table wrap: keeps ‚Äú–û—Ç—á–µ—Ç‚Äù compact, scroll inside */
    .tableWrap {
      max-height: 380px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }
    @media (max-width: 600px) {
      .tableWrap { max-height: 300px; }
    }

    /* Confetti */
    .confetti {
      position: fixed;
      pointer-events: none;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      overflow: hidden;
      z-index: 9999;
    }
    .confetti i {
      position: absolute;
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(26,115,232,.9);
      opacity: .95;
      transform: translate(-50%, -50%);
      animation: pop .45s ease-out forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.12));
    }
    @keyframes pop {
      from { transform: translate(-50%,-50%) scale(1); opacity:.95; }
      to   { transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(.8); opacity:0; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="sticker">
      –î–æ—Ä–æ–≥—É –æ—Å–∏–ª–∏—Ç –∏–¥—É—â–∏–π
      <small>‚Äî —Ñ–∏–∫—Å–∏—Ä—É–π –æ–ø–ª–∞—Ç—É –æ–¥–Ω–∏–º —Ç–∞–ø–æ–º</small>
    </div>

    <h1>–ö–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–ª–∞—Ç –ø–æ –∞—Ä–µ–Ω–¥–µ –≥–∞—Ä–∞–∂–µ–π</h1>
    <p class="muted" style="margin:0 0 12px;">
      –û–ø–ª–∞—Ç—ã –º–æ–∂–Ω–æ –æ—Ç–º–µ—á–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–ª–∏ —á–∞—Å—Ç—è–º–∏. –õ—å–≥–æ—Ç–∞: 2 –¥–Ω—è. –î–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Äî –¥–µ–ª–∞–π –±—ç–∫–∞–ø –≤ Telegram.
    </p>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div class="card">
        <h2>–ü–∞–Ω–µ–ª—å –æ–ø–ª–∞—Ç</h2>

        <div class="tabs" id="quickTabs">
          <div class="tab active" data-mode="all" id="tabAll">–í—Å–µ</div>
          <div class="tab" data-mode="overdue" id="tabOverdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
          <div class="tab" data-mode="grace" id="tabGrace">–õ—å–≥–æ—Ç–∞</div>
          <div class="tab" data-mode="due7" id="tabDue7">–°–∫–æ—Ä–æ</div>
        </div>

        <div class="row">
          <div>
            <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å</label>
            <select id="viewMode">
              <option value="all">–í—Å–µ</option>
              <option value="unpaid">–¢–æ–ª—å–∫–æ –ù–ï –æ–ø–ª–∞—á–µ–Ω–æ</option>
              <option value="due7">–°—Ä–æ–∫ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π</option>
              <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
              <option value="grace">–õ—å–≥–æ—Ç–∞ (2 –¥–Ω—è)</option>
            </select>
          </div>

          <div>
            <label>–ü–æ–∏—Å–∫ (–≥–∞—Ä–∞–∂ –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä)</label>
            <input id="searchText" placeholder="–ù–∞–ø—Ä. –ì–∞—Ä–∞–∂ #3 / –ò–≤–∞–Ω / +7903..." />
          </div>

          <div style="align-self:end; min-width: 120px; flex:0;">
            <button class="secondary" id="clearSearchBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>

          <div>
            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select id="sortMode">
              <option value="urgent">–ü–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏</option>
              <option value="nextpay">–ü–æ –±–ª–∏–∂–∞–π—à–µ–π –æ–ø–ª–∞—Ç–µ</option>
              <option value="day">–ü–æ –¥–Ω—é –æ–ø–ª–∞—Ç—ã (1‚Äì28)</option>
              <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
            </select>
          </div>

          <div>
            <label>–î–∞—Ç–∞ ‚Äú—Å–µ–≥–æ–¥–Ω—è‚Äù (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)</label>
            <input id="fakeToday" type="date" />
          </div>

          <div style="align-self:end; min-width: 120px; flex:0;">
            <button class="secondary" id="resetTodayBtn">–°–µ–≥–æ–¥–Ω—è</button>
          </div>
        </div>

        <div class="kpi" style="margin-top:12px;">
          <div class="box">
            <div class="name">–û–ø–ª–∞—á–µ–Ω–æ (—Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥)</div>
            <div class="val good" id="kpiPaid">0</div>
          </div>
          <div class="box">
            <div class="name">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ / –î–æ–ª–≥–∏</div>
            <div class="val bad" id="kpiUnpaid">0</div>
          </div>
          <div class="box">
            <div class="name">–û–∂–∏–¥–∞–µ—Ç—Å—è –∫ —Å–±–æ—Ä—É</div>
            <div class="val" id="kpiExpected">0 ‚ÇΩ</div>
          </div>
        </div>

        <div style="margin-top:12px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>–ì–∞—Ä–∞–∂ / –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä</th>
                <th class="nowrap">–î–µ–Ω—å</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th class="nowrap">–ê—Ä–µ–Ω–¥–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th class="nowrap">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="payTable"></tbody>
          </table>
        </div>

        <p class="muted" style="margin:10px 0 0;">
          –ü–µ—Ä–∏–æ–¥: —Å –¥–Ω—è –æ–ø–ª–∞—Ç—ã –ø–æ –¥–µ–Ω—å –ø–µ—Ä–µ–¥ –Ω–∏–º –≤ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ. –ü—Ä–æ—Å—Ä–æ—á–∫–∞ ‚Äî –Ω–∞ 3-–π –¥–µ–Ω—å –ø–æ—Å–ª–µ —Å—Ä–æ–∫–∞ (–ª—å–≥–æ—Ç–∞ 2 –¥–Ω—è).
        </p>
      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card">
          <h2>–ì–∞—Ä–∞–∂–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

          <div class="row">
            <div>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞</label>
              <input id="garageName" placeholder="–ù–∞–ø—Ä. –ì–∞—Ä–∞–∂ #1 (—Å–≤–µ—Ç)" />
            </div>
            <div style="align-self:end;">
              <button id="addGarageBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–∞—Ä–∞–∂</button>
            </div>
          </div>

          <label>–í—ã–±–µ—Ä–∏ –≥–∞—Ä–∞–∂ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
          <select id="garageSelect" size="6"></select>

          <div class="row" style="margin-top:10px;">
            <button class="secondary" id="renameGarageBtn">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button class="danger" id="deleteGarageBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>

          <hr style="margin:14px 0; border:none; border-top:1px solid #eef0f6;" />

          <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã</h2>
          <label>–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä</label>
          <input id="tenantName" placeholder="–ò–º—è/–Ω–∏–∫, –º–æ–∂–Ω–æ —Ç–µ–ª–µ—Ñ–æ–Ω" />

          <div class="row">
            <div>
              <label>–ê—Ä–µ–Ω–¥–∞ –≤ –º–µ—Å—è—Ü (‚ÇΩ)</label>
              <input id="rentAmount" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä. 6000" />
            </div>
            <div>
              <label>–î–µ–Ω—å –æ–ø–ª–∞—Ç—ã (1‚Äì28)</label>
              <input id="rentDay" type="number" min="1" max="28" step="1" placeholder="–ù–∞–ø—Ä. 17" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="secondary" id="saveSettingsBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>

          <hr style="margin:14px 0; border:none; border-top:1px solid #eef0f6;" />

          <h2>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</h2>
          <div class="row">
            <div style="min-width: 220px;">
              <button class="secondary" id="backupBtn">üì¶ –ë—ç–∫–∞–ø (–≤ Telegram)</button>
              <div class="mini">–°–∫–∞—á–∞–µ—Ç —Ñ–∞–π–ª ‚Äî –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ –≤ Telegram ‚Üí ‚Äú–ò–∑–±—Ä–∞–Ω–Ω–æ–µ‚Äù.</div>
            </div>
            <div style="min-width: 220px;">
              <button class="secondary" id="restoreBtn">‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
              <div class="mini">–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª <b>garage-backup-....json</b>.</div>
            </div>
          </div>

          <div class="mini" id="backupHint" style="margin-top:8px;"></div>
          <input id="restoreFile" type="file" accept="application/json" style="display:none;" />
        </div>

        <div class="card" style="margin-top:14px;">
          <h2>–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>

          <label>–ì–∞—Ä–∞–∂</label>
          <select id="txGarage"></select>

          <div class="row">
            <div>
              <label>–¢–∏–ø</label>
              <select id="txType">
                <option value="income">–î–æ—Ö–æ–¥</option>
                <option value="expense">–†–∞—Å—Ö–æ–¥</option>
              </select>
            </div>
            <div>
              <label>–°—É–º–º–∞ (‚ÇΩ)</label>
              <input id="txAmount" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä. 500" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–î–∞—Ç–∞</label>
              <input id="txDate" type="date" />
            </div>
            <div>
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <input id="txCategory" placeholder="–°–≤–µ—Ç / –†–µ–º–æ–Ω—Ç / –ù–∞–ª–æ–≥..." />
            </div>
          </div>

          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="txNote" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø–æ —Å—É—Ç–∏"></textarea>

          <div style="margin-top:10px;">
            <button id="addTxBtn">‚ûï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
          </div>

          <p class="muted" style="margin:10px 0 0;">
            –ê—Ä–µ–Ω–¥—É –ª—É—á—à–µ –æ—Ç–º–µ—á–∞—Ç—å –≤ ‚Äú–ü–∞–Ω–µ–ª–∏ –æ–ø–ª–∞—Ç‚Äù ‚Äî —Ç–∞–º —É—á—ë—Ç —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ–ø–ª–∞—Ç –∏ –ø–µ—Ä–∏–æ–¥.
          </p>
        </div>
      </div>
    </div><!-- /grid -->

    <!-- REPORT: —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –í–ù–ï grid, —á—Ç–æ–±—ã –±—ã–ª –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
    <div class="card" style="margin-top:14px;">
      <h2>–û—Ç—á–µ—Ç (–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –º–µ—Å—è—Ü)</h2>
      <div class="row">
        <div>
          <label>–§–∏–ª—å—Ç—Ä: –≥–∞—Ä–∞–∂</label>
          <select id="filterGarage"></select>
        </div>
        <div>
          <label>–§–∏–ª—å—Ç—Ä: –º–µ—Å—è—Ü</label>
          <input id="filterMonth" type="month" />
        </div>
        <div style="align-self:end; min-width: 120px; flex:0;">
          <button class="secondary" id="resetFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px;">
        <div class="box">
          <div class="name">–î–æ—Ö–æ–¥</div>
          <div class="val good" id="kpiIncome">0 ‚ÇΩ</div>
        </div>
        <div class="box">
          <div class="name">–†–∞—Å—Ö–æ–¥</div>
          <div class="val bad" id="kpiExpense">0 ‚ÇΩ</div>
        </div>
        <div class="box">
          <div class="name">–ü—Ä–∏–±—ã–ª—å</div>
          <div class="val" id="kpiProfit">0 ‚ÇΩ</div>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–ì–∞—Ä–∞–∂</th>
              <th>–¢–∏–ø</th>
              <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
              <th>–°—É–º–º–∞</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ GitHub iPhone ‚Äú–Ω–µ –≤–∏–¥–∏—Ç‚Äù –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî —Å–º–∞—Ö–Ω–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –æ—Ç–∫—Ä–æ–π —Å–Ω–æ–≤–∞.
      </p>
    </div>
  </div>

<script>
  const KEY = "garage_rent_v8";
  const GRACE_DAYS = 2;

  const BACKUP_META_KEY = "garage_rent_backup_meta_v1";
  const REMIND_DAYS = 31;

  function uid() { return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function parseJSON(s) { try { return JSON.parse(s); } catch(e) { return null; } }
  function save(state) { localStorage.setItem(KEY, JSON.stringify(state)); }
  function fmtRub(n) { return (Math.round(Number(n) || 0)).toLocaleString("ru-RU") + " ‚ÇΩ"; }

  function todayISO() {
    const d = new Date();
    const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return tz.toISOString().slice(0,10);
  }

  function addMonths(dateObj, months) {
    const d = new Date(dateObj);
    const day = d.getDate();
    d.setDate(1);
    d.setMonth(d.getMonth() + months);
    const lastDay = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    d.setDate(Math.min(day, lastDay));
    return d;
  }

  function isoFromDate(d) {
    const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return tz.toISOString().slice(0,10);
  }

  function dateFromISO(iso) {
    const [y,m,dd] = (iso || "").split("-").map(Number);
    return new Date(y, (m||1)-1, dd||1);
  }

  function monthKey(isoDate) { return (isoDate || "").slice(0,7); }

  function monthNameRuFromISO(iso) {
    const d = dateFromISO(iso);
    const months = ["—è–Ω–≤–∞—Ä—å","—Ñ–µ–≤—Ä–∞–ª—å","–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥—É—Å—Ç","—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"];
    return months[d.getMonth()];
  }

  function calcPeriod(forISO, rentDay) {
    const day = Math.max(1, Math.min(28, Number(rentDay || 1)));
    const t = dateFromISO(forISO);
    const y = t.getFullYear();
    const m = t.getMonth();

    const thisMonthStart = new Date(y, m, day);
    let start = thisMonthStart;
    if (t < thisMonthStart) start = new Date(y, m-1, day);

    const end = new Date(addMonths(start, 1).getTime() - 24*60*60*1000);
    return { startISO: isoFromDate(start), endISO: isoFromDate(end), periodId: isoFromDate(start) };
  }

  function daysBetweenISO(aISO, bISO) {
    const a = dateFromISO(aISO);
    const b = dateFromISO(bISO);
    return Math.round((b - a) / (24*60*60*1000));
  }

  function migrateIfNeeded() {
    const v8 = parseJSON(localStorage.getItem(KEY));
    if (v8 && v8.garages) return v8;

    const v7 = parseJSON(localStorage.getItem("garage_rent_v7"));
    const v6 = parseJSON(localStorage.getItem("garage_rent_v6"));
    const v5 = parseJSON(localStorage.getItem("garage_rent_v5"));
    const v4 = parseJSON(localStorage.getItem("garage_rent_v4"));
    const v3 = parseJSON(localStorage.getItem("garage_rent_v3"));
    const v2 = parseJSON(localStorage.getItem("garage_rent_v2"));
    const v1 = parseJSON(localStorage.getItem("garage_rent_v1"));

    const src = v7 || v6 || v5 || v4 || v3 || v2 || v1;
    if (src && src.garages) {
      const migrated = {
        garages: (src.garages || []).map(g => ({
          id: g.id || uid(),
          name: g.name || "–ì–∞—Ä–∞–∂",
          rent: Number(g.rent || 0),
          rentDay: Number(g.rentDay || 1),
          tenant: g.tenant || ""
        })),
        tx: (src.tx || []).map(t => ({
          id: t.id || uid(),
          garageId: t.garageId,
          type: t.type,
          amount: Number(t.amount || 0),
          date: t.date,
          category: t.category || "",
          note: t.note || "",
          periodId: t.periodId || ""
        }))
      };
      localStorage.setItem(KEY, JSON.stringify(migrated));
      return migrated;
    }

    const init = { garages: [{ id: uid(), name: "–ì–∞—Ä–∞–∂ #1", rent: 0, rentDay: 1, tenant: "" }], tx: [] };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }

  // Backup meta
  function loadBackupMeta() {
    return parseJSON(localStorage.getItem(BACKUP_META_KEY)) || { lastBackupISO: "" };
  }
  function saveBackupMeta(meta) {
    localStorage.setItem(BACKUP_META_KEY, JSON.stringify(meta));
  }
  function daysSince(iso) {
    if (!iso) return 9999;
    const a = dateFromISO(isoFromDate(new Date()));
    const b = dateFromISO(iso);
    return Math.round((a - b) / (24*60*60*1000));
  }

  // Confetti burst
  function confettiBurst(x, y) {
    const layer = document.createElement("div");
    layer.className = "confetti";
    document.body.appendChild(layer);

    const palette = [
      "rgba(26,115,232,.92)",
      "rgba(11,122,52,.88)",
      "rgba(255,170,0,.85)",
      "rgba(180,35,24,.85)",
      "rgba(120,90,255,.85)"
    ];

    const count = 10;
    for (let i = 0; i < count; i++) {
      const dot = document.createElement("i");
      dot.style.left = x + "px";
      dot.style.top = y + "px";
      dot.style.setProperty("--dx", (Math.random() * 140 - 70).toFixed(0) + "px");
      dot.style.setProperty("--dy", (Math.random() * -120 - 20).toFixed(0) + "px");
      dot.style.background = palette[Math.floor(Math.random() * palette.length)];
      const s = (6 + Math.random()*6).toFixed(0);
      dot.style.width = s + "px";
      dot.style.height = s + "px";
      layer.appendChild(dot);
    }

    setTimeout(() => layer.remove(), 650);
  }

  const el = (id) => document.getElementById(id);

  const quickTabs = el("quickTabs");
  const tabAll = el("tabAll");
  const tabOverdue = el("tabOverdue");
  const tabGrace = el("tabGrace");
  const tabDue7 = el("tabDue7");

  const viewMode = el("viewMode");
  const searchText = el("searchText");
  const clearSearchBtn = el("clearSearchBtn");
  const sortMode = el("sortMode");
  const fakeToday = el("fakeToday");
  const resetTodayBtn = el("resetTodayBtn");

  const kpiPaid = el("kpiPaid");
  const kpiUnpaid = el("kpiUnpaid");
  const kpiExpected = el("kpiExpected");
  const payTable = el("payTable");

  const garageName = el("garageName");
  const addGarageBtn = el("addGarageBtn");
  const garageSelect = el("garageSelect");
  const renameGarageBtn = el("renameGarageBtn");
  const deleteGarageBtn = el("deleteGarageBtn");

  const tenantName = el("tenantName");
  const rentAmount = el("rentAmount");
  const rentDay = el("rentDay");
  const saveSettingsBtn = el("saveSettingsBtn");

  const backupBtn = el("backupBtn");
  const restoreBtn = el("restoreBtn");
  const restoreFile = el("restoreFile");
  const backupHint = el("backupHint");

  const txGarage = el("txGarage");
  const txType = el("txType");
  const txAmount = el("txAmount");
  const txDate = el("txDate");
  const txCategory = el("txCategory");
  const txNote = el("txNote");
  const addTxBtn = el("addTxBtn");

  const filterGarage = el("filterGarage");
  const filterMonth = el("filterMonth");
  const resetFiltersBtn = el("resetFiltersBtn");

  const kpiIncome = el("kpiIncome");
  const kpiExpense = el("kpiExpense");
  const kpiProfit = el("kpiProfit");
  const txTable = el("txTable");

  let state = migrateIfNeeded();

  function getGarage(id) { return state.garages.find(g => g.id === id) || null; }
  function getGarageName(id) { const g = getGarage(id); return g ? g.name : "‚Äî"; }

  function rentPaidSumForPeriod(garageId, periodId) {
    return state.tx
      .filter(t =>
        t.garageId === garageId &&
        t.type === "income" &&
        (t.category || "").toLowerCase().trim() === "–∞—Ä–µ–Ω–¥–∞" &&
        (t.periodId || "") === periodId
      )
      .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
  }

  function statusBadge(kind, text) {
    const span = document.createElement("span");
    span.className = "status " + (kind === "ok" ? "ok" : kind === "soon" ? "soon" : kind === "neutral" ? "neutral" : "bad");
    span.textContent = text;
    return span;
  }

  function loadGarageSettingsToForm() {
    const g = getGarage(garageSelect.value);
    if (!g) return;
    tenantName.value = g.tenant || "";
    rentAmount.value = g.rent || "";
    rentDay.value = g.rentDay || 1;
  }

  function getToday() { return fakeToday.value || todayISO(); }

  function refreshSelects() {
    garageSelect.innerHTML = "";
    txGarage.innerHTML = "";
    filterGarage.innerHTML = "";

    state.garages.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.name;
      garageSelect.appendChild(opt);

      const opt2 = document.createElement("option");
      opt2.value = g.id;
      opt2.textContent = g.name;
      txGarage.appendChild(opt2);
    });

    const all = document.createElement("option");
    all.value = "";
    all.textContent = "–í—Å–µ –≥–∞—Ä–∞–∂–∏";
    filterGarage.appendChild(all);

    state.garages.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.name;
      filterGarage.appendChild(opt);
    });

    if (state.garages.length) {
      if (!garageSelect.value) garageSelect.value = state.garages[0].id;
      if (!txGarage.value) txGarage.value = state.garages[0].id;
    }
    loadGarageSettingsToForm();
  }

  function matchesSearch(g, query) {
    if (!query) return true;
    const q = query.toLowerCase().trim();
    if (!q) return true;
    const hay = `${g.name || ""} ${g.tenant || ""}`.toLowerCase();
    return hay.includes(q);
  }

  function setActiveTab(mode) {
    [...quickTabs.querySelectorAll(".tab")].forEach(t => t.classList.remove("active"));
    const map = { all: tabAll, overdue: tabOverdue, grace: tabGrace, due7: tabDue7 };
    (map[mode] || tabAll).classList.add("active");
  }

  function refreshBackupHint() {
    const meta = loadBackupMeta();
    if (!meta.lastBackupISO) {
      backupHint.innerHTML = `<span class="status bad">‚ö†Ô∏è –ë—ç–∫–∞–ø –µ—â—ë –Ω–µ –¥–µ–ª–∞–ª–∏</span> <span class="mini">–°–¥–µ–ª–∞–π –∏ –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª –≤ Telegram ‚Üí ‚Äú–ò–∑–±—Ä–∞–Ω–Ω–æ–µ‚Äù.</span>`;
      return;
    }
    const d = daysSince(meta.lastBackupISO);
    if (d >= REMIND_DAYS) {
      backupHint.innerHTML = `<span class="status soon">‚è∞ –ü–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø</span> <span class="mini">–ü—Ä–æ—à–ª–æ ${d} –¥–Ω. —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ (${meta.lastBackupISO}).</span>`;
    } else {
      backupHint.innerHTML = `<span class="status ok">‚úÖ –ë—ç–∫–∞–ø —Å–≤–µ–∂–∏–π</span> <span class="mini">–ü–æ—Å–ª–µ–¥–Ω–∏–π: ${meta.lastBackupISO} (${d} –¥–Ω. –Ω–∞–∑–∞–¥).</span>`;
    }
  }

  function maybeMonthlyReminder() {
    const meta = loadBackupMeta();
    const d = meta.lastBackupISO ? daysSince(meta.lastBackupISO) : 9999;
    if (d >= REMIND_DAYS) {
      setTimeout(() => {
        alert("‚è∞ –ü—Ä–æ—à—ë–ª –º–µ—Å—è—Ü. –°–¥–µ–ª–∞–π —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∏ –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª –≤ Telegram ‚Üí ‚Äú–ò–∑–±—Ä–∞–Ω–Ω–æ–µ‚Äù.");
      }, 250);
    }
  }

  function downloadJSON(filename, dataObj) {
    const blob = new Blob([JSON.stringify(dataObj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 250);
  }

  function safeNormalizeState(obj) {
    if (!obj || typeof obj !== "object") return null;
    if (!Array.isArray(obj.garages) || !Array.isArray(obj.tx)) return null;

    const garages = obj.garages.map(g => ({
      id: String(g.id || uid()),
      name: String(g.name || "–ì–∞—Ä–∞–∂"),
      rent: Math.round(Number(g.rent || 0)),
      rentDay: Math.max(1, Math.min(28, Math.round(Number(g.rentDay || 1)))),
      tenant: String(g.tenant || "")
    }));

    const garageIds = new Set(garages.map(g => g.id));

    const tx = obj.tx
      .filter(t => t && typeof t === "object")
      .map(t => ({
        id: String(t.id || uid()),
        garageId: String(t.garageId || ""),
        type: (t.type === "expense" ? "expense" : "income"),
        amount: Math.round(Number(t.amount || 0)),
        date: String(t.date || ""),
        category: String(t.category || ""),
        note: String(t.note || ""),
        periodId: String(t.periodId || "")
      }))
      .filter(t => garageIds.has(t.garageId) && t.amount > 0 && /^\d{4}-\d{2}-\d{2}$/.test(t.date));

    return { garages, tx };
  }

  function refreshDashboard() {
    const today = getToday();
    const mode = viewMode.value;
    const q = (searchText.value || "").trim();

    let paidCount = 0;
    let unpaidCount = 0;
    let expected = 0;

    let cntOverdue = 0, cntGrace = 0, cntDue7 = 0, cntAll = 0;

    payTable.innerHTML = "";

    let rows = state.garages
      .filter(g => matchesSearch(g, q))
      .map(g => {
        const rent = Number(g.rent || 0);
        const day = Number(g.rentDay || 1);
        const period = calcPeriod(today, day);

        const paidSum = rent > 0 ? rentPaidSumForPeriod(g.id, period.periodId) : 0;
        const debt = Math.max(0, rent - paidSum);
        const fullyPaid = (rent > 0) && (paidSum >= rent);

        const nextStart = dateFromISO(period.startISO);
        const nextDue = addMonths(nextStart, 1);
        const nextDueISO = isoFromDate(nextDue);

        const dleft = daysBetweenISO(today, nextDueISO);
        const daysAfterDue = -dleft;

        const inGrace = (!fullyPaid) && (daysAfterDue > 0 && daysAfterDue <= GRACE_DAYS);
        const overdue = (!fullyPaid) && (daysAfterDue > GRACE_DAYS);
        const dueSoon = (!fullyPaid) && !inGrace && !overdue && (dleft >= 0 && dleft <= 7);

        const overdueDays = overdue ? (daysAfterDue - GRACE_DAYS) : 0;
        const graceLeft = inGrace ? (GRACE_DAYS - daysAfterDue + 1) : 0;

        cntAll++;
        if (overdue) cntOverdue++;
        if (inGrace) cntGrace++;
        if (dueSoon) cntDue7++;

        if (mode === "unpaid" && fullyPaid) return null;
        if (mode === "due7" && !dueSoon) return null;
        if (mode === "overdue" && !overdue) return null;
        if (mode === "grace" && !inGrace) return null;

        if (fullyPaid) paidCount++;
        else unpaidCount++;

        if (!fullyPaid && rent > 0) expected += debt;

        const periodLabel = monthNameRuFromISO(period.startISO);

        return {
          g, rent, day, period,
          fullyPaid, paidSum, debt,
          dleft, inGrace, overdue, dueSoon,
          nextDueISO, overdueDays, graceLeft,
          periodLabel
        };
      })
      .filter(Boolean);

    tabAll.textContent = `–í—Å–µ (${cntAll})`;
    tabOverdue.textContent = `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (${cntOverdue})`;
    tabGrace.textContent = `–õ—å–≥–æ—Ç–∞ (${cntGrace})`;
    tabDue7.textContent = `–°–∫–æ—Ä–æ (${cntDue7})`;

    // Sorting
    const modeSort = sortMode.value;
    if (modeSort === "name") {
      rows.sort((a, b) => a.g.name.localeCompare(b.g.name, "ru"));
    } else if (modeSort === "day") {
      rows.sort((a, b) => (a.day - b.day) || a.g.name.localeCompare(b.g.name, "ru"));
    } else if (modeSort === "nextpay") {
      rows.sort((a, b) => a.nextDueISO.localeCompare(b.nextDueISO) || a.g.name.localeCompare(b.g.name, "ru"));
    } else {
      // urgent
      rows.sort((a,b) => {
        const bucket = (x) => (x.overdue ? 0 : x.inGrace ? 1 : x.dueSoon ? 2 : 3);
        const ba = bucket(a), bb = bucket(b);
        if (ba !== bb) return ba - bb;

        if (a.overdue && b.overdue) return b.overdueDays - a.overdueDays;
        if (a.inGrace && b.inGrace) return a.graceLeft - b.graceLeft;
        if (a.dueSoon && b.dueSoon) return a.dleft - b.dleft;

        return a.g.name.localeCompare(b.g.name, "ru");
      });
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");

      const who = document.createElement("div");
      who.innerHTML =
        `<div><b>${r.g.name}</b></div>` +
        `<div class="mini">${(r.g.tenant || "").trim() ? r.g.tenant : "‚Äî –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω"}</div>`;

      // –ü–µ—Ä–∏–æ–¥: –¢–û–õ–¨–ö–û –º–µ—Å—è—Ü
      const periodCellHTML = `<div><b>${r.periodLabel}</b></div>`;

      const statusCell = document.createElement("td");
      if (r.rent <= 0) {
        statusCell.appendChild(statusBadge("neutral", "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"));
      } else if (r.fullyPaid) {
        statusCell.appendChild(statusBadge("ok", "–û–ø–ª–∞—á–µ–Ω–æ"));
      } else if (r.debt > 0 && r.paidSum > 0) {
        statusCell.appendChild(statusBadge("bad", `–î–æ–ª–≥: ${fmtRub(r.debt)}`));
      } else if (r.overdue) {
        statusCell.appendChild(statusBadge("bad", `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${r.overdueDays} –¥–Ω.`));
      } else if (r.inGrace) {
        statusCell.appendChild(statusBadge("soon", `–õ—å–≥–æ—Ç–∞: –æ—Å—Ç–∞–ª–æ—Å—å ${r.graceLeft} –¥–Ω.`));
      } else if (r.dueSoon) {
        statusCell.appendChild(statusBadge("soon", `–°—Ä–æ–∫ —á–µ—Ä–µ–∑ ${r.dleft} –¥–Ω.`));
      } else {
        statusCell.appendChild(statusBadge("bad", "–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ"));
      }

      const actionCell = document.createElement("td");
      const actions = document.createElement("div");
      actions.className = "actions";

      const payBtn = document.createElement("button");
      payBtn.textContent = "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ";
      payBtn.disabled = r.fullyPaid || r.rent <= 0;
      payBtn.onclick = (ev) => {
        if (r.rent <= 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π —Å—É–º–º—É –∞—Ä–µ–Ω–¥—ã."); return; }
        const amount = Math.max(0, r.rent - r.paidSum);
        if (amount <= 0) { refreshDashboard(); return; }

        const wasFullyPaid = r.fullyPaid;

        state.tx.push({
          id: uid(),
          garageId: r.g.id,
          type: "income",
          amount: Math.round(amount),
          date: today,
          category: "–ê—Ä–µ–Ω–¥–∞",
          note: `–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–∏–æ–¥–∞ ${r.period.periodId}`,
          periodId: r.period.periodId
        });
        save(state);

        const nowSum = rentPaidSumForPeriod(r.g.id, r.period.periodId);
        const nowFully = (r.rent > 0) && (nowSum >= r.rent);
        if (!wasFullyPaid && nowFully) {
          const rect = ev.currentTarget.getBoundingClientRect();
          confettiBurst(rect.left + rect.width/2, rect.top + rect.height/2);
        }

        refreshDashboard();
        refreshReport();
      };

      const partialBtn = document.createElement("button");
      partialBtn.className = "secondary";
      partialBtn.textContent = "üßæ –ß–∞—Å—Ç–∏—á–Ω–æ";
      partialBtn.disabled = r.fullyPaid || r.rent <= 0;
      partialBtn.onclick = (ev) => {
        if (r.rent <= 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π —Å—É–º–º—É –∞—Ä–µ–Ω–¥—ã."); return; }

        const suggested = Math.min(r.debt || r.rent, r.rent).toString();
        const raw = prompt(
          `–°–∫–æ–ª—å–∫–æ –ø—Ä–∏—à–ª–æ? (‚ÇΩ)\n–ê—Ä–µ–Ω–¥–∞: ${fmtRub(r.rent)}\n–£–∂–µ –∑–∞ –ø–µ—Ä–∏–æ–¥: ${fmtRub(r.paidSum)}\n–û—Å—Ç–∞—Ç–æ–∫: ${fmtRub(r.debt)}`,
          suggested
        );
        if (raw === null) return;

        const amt = Math.round(Number(String(raw).replace(",", ".")) || 0);
        if (amt <= 0) { alert("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0."); return; }

        const newSum = r.paidSum + amt;
        if (newSum > r.rent) {
          const over = newSum - r.rent;
          if (!confirm(`–ü–æ–ª—É—á–∏—Ç—Å—è –ø–µ—Ä–µ–ø–ª–∞—Ç–∞ ${fmtRub(over)} –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥.\n–ó–∞—á–µ—Å—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ?`)) return;
        }

        const wasFullyPaid = r.fullyPaid;

        state.tx.push({
          id: uid(),
          garageId: r.g.id,
          type: "income",
          amount: Math.round(amt),
          date: today,
          category: "–ê—Ä–µ–Ω–¥–∞",
          note: `–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥ ${r.period.periodId}`,
          periodId: r.period.periodId
        });
        save(state);

        const nowSum = rentPaidSumForPeriod(r.g.id, r.period.periodId);
        const nowFully = (r.rent > 0) && (nowSum >= r.rent);
        if (!wasFullyPaid && nowFully) {
          const rect = ev.currentTarget.getBoundingClientRect();
          confettiBurst(rect.left + rect.width/2, rect.top + rect.height/2);
        }

        refreshDashboard();
        refreshReport();
      };

      const settingsBtn = document.createElement("button");
      settingsBtn.className = "secondary";
      settingsBtn.textContent = "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å";
      settingsBtn.onclick = () => {
        garageSelect.value = r.g.id;
        loadGarageSettingsToForm();
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      actions.appendChild(payBtn);
      actions.appendChild(partialBtn);
      actions.appendChild(settingsBtn);
      actionCell.appendChild(actions);

      tr.innerHTML = `
        <td></td>
        <td class="nowrap">${r.day || "‚Äî"}</td>
        <td>${periodCellHTML}</td>
        <td class="nowrap">${r.rent ? fmtRub(r.rent) : "‚Äî"}</td>
        <td></td>
        <td class="nowrap"></td>
      `;

      tr.children[0].appendChild(who);
      tr.children[4].replaceWith(statusCell);
      tr.children[5].replaceWith(actionCell);

      payTable.appendChild(tr);
    });

    kpiPaid.textContent = String(paidCount);
    kpiUnpaid.textContent = String(unpaidCount);
    kpiExpected.textContent = fmtRub(expected);

    refreshBackupHint();
  }

  function applyFiltersTx(tx) {
    let res = [...tx];
    const g = filterGarage.value;
    const m = filterMonth.value;
    if (g) res = res.filter(t => t.garageId === g);
    if (m) res = res.filter(t => (t.date || "").slice(0,7) === m);
    res.sort((a,b) => (b.date || "").localeCompare(a.date || ""));
    return res;
  }

  function refreshReport() {
    const rows = applyFiltersTx(state.tx);

    let inc = 0, exp = 0;
    rows.forEach(t => {
      const amt = Number(t.amount) || 0;
      if (t.type === "income") inc += amt;
      else exp += amt;
    });

    kpiIncome.textContent = fmtRub(inc);
    kpiExpense.textContent = fmtRub(exp);

    const profit = inc - exp;
    kpiProfit.textContent = fmtRub(profit);
    kpiProfit.classList.toggle("good", profit > 0);
    kpiProfit.classList.toggle("bad", profit < 0);

    txTable.innerHTML = "";
    rows.forEach(t => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.date || "‚Äî"}</td>
        <td>${getGarageName(t.garageId)}</td>
        <td>${t.type === "income" ? "–î–æ—Ö–æ–¥" : "–†–∞—Å—Ö–æ–¥"}</td>
        <td>${(t.category || "").trim() || "‚Äî"}</td>
        <td>${fmtRub(t.amount)}</td>
        <td>${(t.note || "").trim() || "‚Äî"}</td>
        <td></td>
      `;
      const delBtn = document.createElement("button");
      delBtn.className = "secondary";
      delBtn.textContent = "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å";
      delBtn.onclick = () => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?")) return;
        state.tx = state.tx.filter(x => x.id !== t.id);
        save(state);
        refreshReport();
        refreshDashboard();
      };
      tr.children[6].appendChild(delBtn);
      txTable.appendChild(tr);
    });
  }

  // --- events ---
  addGarageBtn.onclick = () => {
    const name = (garageName.value || "").trim();
    if (!name) { alert("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞."); return; }
    state.garages.push({ id: uid(), name, rent: 0, rentDay: 1, tenant: "" });
    garageName.value = "";
    save(state);
    refreshSelects();
    refreshDashboard();
    refreshReport();
  };

  garageSelect.onchange = loadGarageSettingsToForm;

  renameGarageBtn.onclick = () => {
    const g = getGarage(garageSelect.value);
    if (!g) return;
    const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞:", g.name);
    if (!name) return;
    g.name = name.trim();
    save(state);
    refreshSelects();
    refreshDashboard();
    refreshReport();
  };

  deleteGarageBtn.onclick = () => {
    const g = getGarage(garageSelect.value);
    if (!g) return;
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${g.name}" –∏ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –Ω–µ–º—É?`)) return;
    state.garages = state.garages.filter(x => x.id !== g.id);
    state.tx = state.tx.filter(t => t.garageId !== g.id);
    save(state);
    refreshSelects();
    refreshDashboard();
    refreshReport();
  };

  saveSettingsBtn.onclick = () => {
    const g = getGarage(garageSelect.value);
    if (!g) return;

    const rent = Math.round(Number(rentAmount.value) || 0);
    const day = Math.round(Number(rentDay.value) || 1);
    const tenant = (tenantName.value || "").trim();

    if (rent < 0) { alert("–°—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π."); return; }
    if (day < 1 || day > 28) { alert("–î–µ–Ω—å –æ–ø–ª–∞—Ç—ã: 1‚Äì28."); return; }

    g.rent = rent;
    g.rentDay = day;
    g.tenant = tenant;

    save(state);
    refreshDashboard();
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
  };

  quickTabs.addEventListener("click", (e) => {
    const tab = e.target.closest(".tab");
    if (!tab) return;
    const mode = tab.dataset.mode;
    viewMode.value = mode;
    setActiveTab(mode);
    refreshDashboard();
  });

  viewMode.onchange = () => {
    setActiveTab(viewMode.value);
    refreshDashboard();
  };

  sortMode.onchange = refreshDashboard;
  fakeToday.onchange = refreshDashboard;
  resetTodayBtn.onclick = () => { fakeToday.value = todayISO(); refreshDashboard(); };

  let searchTimer = null;
  searchText.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(refreshDashboard, 120);
  });

  clearSearchBtn.onclick = () => {
    searchText.value = "";
    refreshDashboard();
    searchText.focus();
  };

  addTxBtn.onclick = () => {
    const garageId = txGarage.value;
    if (!garageId) { alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –≥–∞—Ä–∞–∂."); return; }

    const type = txType.value;
    const amount = Number(txAmount.value);
    const date = txDate.value;
    const category = (txCategory.value || "").trim();
    const note = (txNote.value || "").trim();

    if (!date) { alert("–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É."); return; }
    if (!Number.isFinite(amount) || amount <= 0) { alert("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0."); return; }

    state.tx.push({ id: uid(), garageId, type, amount: Math.round(amount), date, category, note, periodId: "" });
    txAmount.value = ""; txCategory.value = ""; txNote.value = "";
    save(state);
    refreshReport();
    refreshDashboard();
  };

  filterGarage.onchange = refreshReport;
  filterMonth.onchange = refreshReport;
  resetFiltersBtn.onclick = () => {
    filterGarage.value = "";
    filterMonth.value = monthKey(todayISO());
    refreshReport();
  };

  // Backup / Restore
  backupBtn.onclick = () => {
    const now = todayISO();
    const filename = `garage-backup-${now.slice(0,7)}.json`;

    const payload = {
      app: "garage-rent",
      version: KEY,
      createdISO: now,
      data: state
    };

    downloadJSON(filename, payload);

    const meta = loadBackupMeta();
    meta.lastBackupISO = now;
    saveBackupMeta(meta);
    refreshBackupHint();

    alert("üì¶ –ë—ç–∫–∞–ø —Å–∫–∞—á–∞–ª—Å—è. –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª –≤ Telegram ‚Üí ‚Äú–ò–∑–±—Ä–∞–Ω–Ω–æ–µ‚Äù.");
  };

  restoreBtn.onclick = () => restoreFile.click();

  restoreFile.addEventListener("change", async () => {
    const f = restoreFile.files && restoreFile.files[0];
    restoreFile.value = "";
    if (!f) return;

    try {
      const text = await f.text();
      const obj = parseJSON(text);
      const rawData = obj && obj.data ? obj.data : obj;
      const normalized = safeNormalizeState(rawData);

      if (!normalized) {
        alert("–§–∞–π–ª –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –±—ç–∫–∞–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —ç—Ç–æ garage-backup-...json");
        return;
      }

      if (!confirm("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.")) return;

      state = normalized;
      save(state);

      const meta = loadBackupMeta();
      if (!meta.lastBackupISO) meta.lastBackupISO = todayISO();
      saveBackupMeta(meta);

      refreshSelects();
      refreshDashboard();
      refreshReport();
      alert("‚ôªÔ∏è –ì–æ—Ç–æ–≤–æ. –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.");
    } catch (e) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π.");
    }
  });

  // init
  fakeToday.value = todayISO();
  txDate.value = todayISO();
  filterMonth.value = monthKey(todayISO());

  refreshSelects();
  setActiveTab("all");
  refreshDashboard();
  refreshReport();

  refreshBackupHint();
  maybeMonthlyReminder();
</script>
</body>
</html>
