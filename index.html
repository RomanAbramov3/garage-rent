<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê—Ä–µ–Ω–¥–∞ –≥–∞—Ä–∞–∂–µ–π ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–ª–∞—Ç</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 1050px; margin: 0 auto; padding: 18px; position: relative; }
    h1 { margin: 0 0 10px; font-size: 22px; }
    h2 { margin: 0 0 10px; font-size: 16px; }

    /* subtle background pattern */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(circle at 20px 20px, rgba(26,115,232,.06) 1px, transparent 1px);
      background-size: 26px 26px;
      pointer-events:none;
      z-index:0;
    }

    .grid { display:grid; gap:14px; grid-template-columns: 1fr; position: relative; z-index:1; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1.2fr .8fr; } }
    .card { background:#fff; border:1px solid #e6e8ef; border-radius:14px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    label { display:block; font-size: 12px; color:#555; margin: 10px 0 6px; }
    input, select, button, textarea { width:100%; box-sizing: border-box; padding:10px; border-radius:10px; border:1px solid #d7dbe6; background:#fff; }
    textarea { resize: vertical; min-height: 44px; }
    button { cursor:pointer; border:0; background:#1a73e8; color:#fff; font-weight:650; }
    button.secondary { background:#eef2ff; color:#1f2a44; border:1px solid #d7dbe6; }
    button.danger { background:#ffe9e9; color:#7a0610; border:1px solid #f5b5b5; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row > * { flex:1; min-width: 160px; }
    .muted { color:#666; font-size: 12px; }
    .status { display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px; border:1px solid #e6e8ef; font-size:12px; }
    .ok { background:#eaf6ee; border-color:#bfe7cd; }
    .bad { background:#fdecec; border-color:#f7b4b4; }
    .soon { background:#fff6e6; border-color:#ffe1a8; }
    .kpi { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .kpi .box { padding:12px; border-radius:12px; border:1px solid #e6e8ef; background:#fbfcff; }
    .kpi .name { font-size: 12px; color:#555; }
    .kpi .val { font-size: 18px; font-weight: 750; margin-top: 4px; }
    .val.good { color:#0b7a34; }
    .val.bad { color:#b42318; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #eef0f6; text-align:left; font-size: 13px; vertical-align: top; }
    th { font-size: 12px; color:#555; font-weight: 650; }
    .mini { font-size:12px; color:#666; margin-top:3px; }
    .actions { display:flex; gap:8px; flex-wrap: wrap; }
    .actions button { padding:8px 10px; border-radius:10px; }
    .nowrap { white-space: nowrap; }

    .tabs { display:flex; gap:8px; overflow:auto; padding-bottom: 6px; -webkit-overflow-scrolling: touch; }
    .tab { flex:0 0 auto; padding:8px 12px; border-radius:999px; border:1px solid #e6e8ef; background:#fbfcff; font-size:13px; color:#1f2a44; cursor:pointer; user-select:none; }
    .tab.active { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .tab:active { transform: translateY(1px); }

    /* Table wrapper for report: keep the block compact */
    .tableWrap {
      max-height: 380px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }
    @media (max-width: 600px) {
      .tableWrap { max-height: 300px; }
    }

    /* Motivational sticker (top-right) */
    .sticker {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 5;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(230,232,239,.9);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      backdrop-filter: blur(8px);
      max-width: 220px;
      transform: rotate(1deg);
      pointer-events: none;
    }
    .sticker .txt{
      font-style: italic;
      font-weight: 700;
      letter-spacing: .2px;
      line-height: 1.15;
      color: rgba(31,42,68,.85);
      text-align: right;
    }
    .sticker .sub{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(100,110,130,.8);
      text-align: right;
    }

    @media (max-width: 520px){
      .sticker{ max-width: 180px; padding: 8px 10px; }
      .sticker .txt{ font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="sticker" id="sticker">
    <div class="txt">–î–æ—Ä–æ–≥—É –æ—Å–∏–ª–∏—Ç –∏–¥—É—â–∏–π</div>
    <div class="sub">üí™ –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ ‚Äî –±–æ–ª—å—à–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
  </div>

  <div class="wrap">
    <h1>–ö–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–ª–∞—Ç –ø–æ –∞—Ä–µ–Ω–¥–µ –≥–∞—Ä–∞–∂–µ–π</h1>
    <p class="muted" style="margin:0 0 12px;">
      –û–¥–∏–Ω —Ç–∞–ø ‚Äî –∑–∞–∫—Ä—ã—Ç—å –∞—Ä–µ–Ω–¥—É –∑–∞ –ø–µ—Ä–∏–æ–¥. –ú–æ–∂–Ω–æ —á–∞—Å—Ç—è–º–∏. –ë—ç–∫–∞–ø –≤ Telegram ‚Äî —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–ª–µ—Ç–µ–ª–∏ –≤ —Å—É–≥—Ä–æ–± –≤–º–µ—Å—Ç–µ —Å iPhone.
    </p>

    <div class="grid">
      <div class="card">
        <h2>–ü–∞–Ω–µ–ª—å –æ–ø–ª–∞—Ç</h2>

        <div class="tabs" id="quickTabs">
          <div class="tab active" data-mode="all" id="tabAll">–í—Å–µ</div>
          <div class="tab" data-mode="overdue" id="tabOverdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
          <div class="tab" data-mode="grace" id="tabGrace">–õ—å–≥–æ—Ç–∞</div>
          <div class="tab" data-mode="due7" id="tabDue7">–°–∫–æ—Ä–æ</div>
        </div>

        <div class="row">
          <div>
            <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å</label>
            <select id="viewMode">
              <option value="all">–í—Å–µ</option>
              <option value="unpaid">–¢–æ–ª—å–∫–æ –ù–ï –æ–ø–ª–∞—á–µ–Ω–æ</option>
              <option value="due7">–°—Ä–æ–∫ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π</option>
              <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
              <option value="grace">–õ—å–≥–æ—Ç–∞ (2 –¥–Ω—è)</option>
            </select>
          </div>

          <div>
            <label>–ü–æ–∏—Å–∫ (–≥–∞—Ä–∞–∂ –∏–ª–∏ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä)</label>
            <input id="searchText" placeholder="–ù–∞–ø—Ä. –ì–∞—Ä–∞–∂ #3 / –ò–≤–∞–Ω / +7903..." />
          </div>

          <div style="align-self:end; min-width: 120px; flex:0;">
            <button class="secondary" id="clearSearchBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>

          <div>
            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select id="sortMode">
              <option value="urgent">–ü–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏</option>
              <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
              <option value="nextDue">–ü–æ –±–ª–∏–∂–∞–π—à–µ–π –æ–ø–ª–∞—Ç–µ</option>
              <option value="day128">–ü–æ –¥–Ω—é –æ–ø–ª–∞—Ç—ã (1‚Äì28)</option>
            </select>
          </div>

          <div>
            <label>–î–∞—Ç–∞ ‚Äú—Å–µ–≥–æ–¥–Ω—è‚Äù (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)</label>
            <input id="fakeToday" type="date" />
          </div>

          <div style="align-self:end; min-width: 120px; flex:0;">
            <button class="secondary" id="resetTodayBtn">–°–µ–≥–æ–¥–Ω—è</button>
          </div>
        </div>

        <div class="kpi" style="margin-top:12px;">
          <div class="box">
            <div class="name">–û–ø–ª–∞—á–µ–Ω–æ (—Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥)</div>
            <div class="val good" id="kpiPaid">0</div>
          </div>
          <div class="box">
            <div class="name">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ / –î–æ–ª–≥–∏</div>
            <div class="val bad" id="kpiUnpaid">0</div>
          </div>
          <div class="box">
            <div class="name">–û–∂–∏–¥–∞–µ—Ç—Å—è –∫ —Å–±–æ—Ä—É</div>
            <div class="val" id="kpiExpected">0 ‚ÇΩ</div>
          </div>
        </div>

        <div style="margin-top:12px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>–ì–∞—Ä–∞–∂ / –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä</th>
                <th class="nowrap">–î–µ–Ω—å</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th class="nowrap">–ê—Ä–µ–Ω–¥–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th class="nowrap">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="payTable"></tbody>
          </table>
        </div>

        <p class="muted" style="margin:10px 0 0;">
          –ü–µ—Ä–∏–æ–¥: —Å ‚Äú–¥–Ω—è –æ–ø–ª–∞—Ç—ã‚Äù –ø–æ –¥–µ–Ω—å –ø–µ—Ä–µ–¥ –Ω–∏–º –≤ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ. –ü—Ä–æ—Å—Ä–æ—á–∫–∞ ‚Äî –Ω–∞ 3-–π –¥–µ–Ω—å –ø–æ—Å–ª–µ —Å—Ä–æ–∫–∞ (–ª—å–≥–æ—Ç–∞ 2 –¥–Ω—è).
        </p>
      </div>

      <div>
        <div class="card">
          <h2>–ì–∞—Ä–∞–∂–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

          <div class="row">
            <div>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞</label>
              <input id="garageName" placeholder="–ù–∞–ø—Ä. –ì–∞—Ä–∞–∂ #1 (—Å–≤–µ—Ç)" />
            </div>
            <div style="align-self:end;">
              <button id="addGarageBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–∞—Ä–∞–∂</button>
            </div>
          </div>

          <label>–í—ã–±–µ—Ä–∏ –≥–∞—Ä–∞–∂ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
          <select id="garageSelect" size="6"></select>

          <div class="row" style="margin-top:10px;">
            <button class="secondary" id="renameGarageBtn">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button class="danger" id="deleteGarageBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>

          <hr style="margin:14px 0; border:none; border-top:1px solid #eef0f6;" />

          <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É</h2>
          <label>–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä</label>
          <input id="tenantName" placeholder="–ò–º—è/–Ω–∏–∫, –º–æ–∂–Ω–æ —Ç–µ–ª–µ—Ñ–æ–Ω" />

          <div class="row">
            <div>
              <label>–ê—Ä–µ–Ω–¥–∞ –≤ –º–µ—Å—è—Ü (‚ÇΩ)</label>
              <input id="rentAmount" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä. 6000" />
            </div>
            <div>
              <label>–î–µ–Ω—å –æ–ø–ª–∞—Ç—ã (1‚Äì28)</label>
              <input id="rentDay" type="number" min="1" max="28" step="1" placeholder="–ù–∞–ø—Ä. 17" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="secondary" id="saveSettingsBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          </div>

          <hr style="margin:14px 0; border:none; border-top:1px solid #eef0f6;" />

          <h2>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è (Telegram)</h2>
          <div class="row">
            <button class="secondary" id="backupBtn">üì¶ –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø</button>
            <button class="secondary" id="restoreBtn">‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <input id="restoreFile" type="file" accept="application/json" style="display:none;" />
          <p class="muted" style="margin:10px 0 0;">
            –ù–∞–∂–º–∏ ‚Äú–ë—ç–∫–∞–ø‚Äù ‚Üí –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª –≤ Telegram ‚Üí ‚Äú–ò–∑–±—Ä–∞–Ω–Ω–æ–µ‚Äù. –†–∞–∑ –≤ –º–µ—Å—è—Ü –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–ø–æ–º–Ω–∏—Ç.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h2>–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Ä–∞—Å—Ö–æ–¥—ã/–ø—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã)</h2>

          <label>–ì–∞—Ä–∞–∂</label>
          <select id="txGarage"></select>

          <div class="row">
            <div>
              <label>–¢–∏–ø</label>
              <select id="txType">
                <option value="income">–î–æ—Ö–æ–¥</option>
                <option value="expense">–†–∞—Å—Ö–æ–¥</option>
              </select>
            </div>
            <div>
              <label>–°—É–º–º–∞ (‚ÇΩ)</label>
              <input id="txAmount" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä. 500" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>–î–∞—Ç–∞</label>
              <input id="txDate" type="date" />
            </div>
            <div>
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <input id="txCategory" placeholder="–°–≤–µ—Ç / –†–µ–º–æ–Ω—Ç / –ù–∞–ª–æ–≥..." />
            </div>
          </div>

          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="txNote" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø–æ —Å—É—Ç–∏"></textarea>

          <div style="margin-top:10px;">
            <button id="addTxBtn">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
          </div>

          <p class="muted" style="margin:10px 0 0;">
            –ê—Ä–µ–Ω–¥—É –ª—É—á—à–µ –æ—Ç–º–µ—á–∞—Ç—å –≤ ‚Äú–ü–∞–Ω–µ–ª–∏ –æ–ø–ª–∞—Ç‚Äù ‚Äî —Ç–∞–º —É—á—ë—Ç —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ–ø–ª–∞—Ç –∏ –¥–æ–ª–≥–∞.
          </p>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>–û—Ç—á–µ—Ç (–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –º–µ—Å—è—Ü)</h2>
      <div class="row">
        <div>
          <label>–§–∏–ª—å—Ç—Ä: –≥–∞—Ä–∞–∂</label>
          <select id="filterGarage"></select>
        </div>
        <div>
          <label>–§–∏–ª—å—Ç—Ä: –º–µ—Å—è—Ü</label>
          <input id="filterMonth" type="month" />
        </div>
        <div style="align-self:end; min-width: 120px; flex:0;">
          <button class="secondary" id="resetFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px;">
        <div class="box">
          <div class="name">–î–æ—Ö–æ–¥</div>
          <div class="val good" id="kpiIncome">0 ‚ÇΩ</div>
        </div>
        <div class="box">
          <div class="name">–†–∞—Å—Ö–æ–¥</div>
          <div class="val bad" id="kpiExpense">0 ‚ÇΩ</div>
        </div>
        <div class="box">
          <div class="name">–ü—Ä–∏–±—ã–ª—å</div>
          <div class="val" id="kpiProfit">0 ‚ÇΩ</div>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–ì–∞—Ä–∞–∂</th>
              <th>–¢–∏–ø</th>
              <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
              <th>–°—É–º–º–∞</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ GitHub iPhone ‚Äú–Ω–µ –≤–∏–¥–∏—Ç‚Äù –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî —Å–º–∞—Ö–Ω–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –æ—Ç–∫—Ä–æ–π —Å–Ω–æ–≤–∞.
      </p>
    </div>
  </div>

<script>
  const KEY = "garage_rent_v7";
  const GRACE_DAYS = 2;
  const LAST_BACKUP_KEY = "garage_rent_last_backup_month"; // YYYY-MM

  function uid() { return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function parseJSON(s) { try { return JSON.parse(s); } catch(e) { return null; } }

  function migrateIfNeeded() {
    const v7 = parseJSON(localStorage.getItem(KEY));
    if (v7 && v7.garages) return v7;

    const keys = ["garage_rent_v6","garage_rent_v5","garage_rent_v4","garage_rent_v3","garage_rent_v2","garage_rent_v1"];
    let src = null;
    for (const k of keys) {
      const v = parseJSON(localStorage.getItem(k));
      if (v && v.garages) { src = v; break; }
    }
    if (src) {
      const migrated = {
        garages: (src.garages || []).map(g => ({
          id: g.id || uid(),
          name: g.name || "–ì–∞—Ä–∞–∂",
          rent: Number(g.rent || 0),
          rentDay: Number(g.rentDay || 1),
          tenant: g.tenant || ""
        })),
        tx: (src.tx || []).map(t => ({
          id: t.id || uid(),
          garageId: t.garageId,
          type: t.type,
          amount: Number(t.amount || 0),
          date: t.date,
          category: t.category || "",
          note: t.note || "",
          periodId: t.periodId || ""
        }))
      };
      localStorage.setItem(KEY, JSON.stringify(migrated));
      return migrated;
    }

    const init = { garages: [{ id: uid(), name: "–ì–∞—Ä–∞–∂ #1", rent: 0, rentDay: 1, tenant: "" }], tx: [] };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }

  function save(state) { localStorage.setItem(KEY, JSON.stringify(state)); }
  function fmtRub(n) { return (Math.round(Number(n) || 0)).toLocaleString("ru-RU") + " ‚ÇΩ"; }

  function todayISO() {
    const d = new Date();
    const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return tz.toISOString().slice(0,10);
  }

  function addMonths(dateObj, months) {
    const d = new Date(dateObj);
    const day = d.getDate();
    d.setDate(1);
    d.setMonth(d.getMonth() + months);
    const lastDay = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    d.setDate(Math.min(day, lastDay));
    return d;
  }

  function isoFromDate(d) {
    const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return tz.toISOString().slice(0,10);
  }

  function dateFromISO(iso) {
    const [y,m,dd] = (iso || "").split("-").map(Number);
    return new Date(y, (m||1)-1, dd||1);
  }

  function monthKey(isoDate) { return (isoDate || "").slice(0,7); }

  function monthNameRuFromISO(iso) {
    const d = dateFromISO(iso);
    const months = ["—è–Ω–≤–∞—Ä—å","—Ñ–µ–≤—Ä–∞–ª—å","–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥—É—Å—Ç","—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"];
    return months[d.getMonth()];
  }

  function calcPeriod(forISO, rentDay) {
    const day = Math.max(1, Math.min(28, Number(rentDay || 1)));
    const t = dateFromISO(forISO);
    const y = t.getFullYear();
    const m = t.getMonth();

    const thisMonthStart = new Date(y, m, day);
    let start = thisMonthStart;
    if (t < thisMonthStart) start = new Date(y, m-1, day);

    const end = new Date(addMonths(start, 1).getTime() - 24*60*60*1000);
    return { startISO: isoFromDate(start), endISO: isoFromDate(end), periodId: isoFromDate(start) };
  }

  function daysBetweenISO(aISO, bISO) {
    const a = dateFromISO(aISO);
    const b = dateFromISO(bISO);
    return Math.round((b - a) / (24*60*60*1000));
  }

  // confetti (tiny, short)
  function confettiBurst(x, y) {
    const count = 10;
    for (let i = 0; i < count; i++) {
      const dot = document.createElement("div");
      dot.style.position = "fixed";
      dot.style.left = x + "px";
      dot.style.top = y + "px";
      dot.style.width = "6px";
      dot.style.height = "6px";
      dot.style.borderRadius = "999px";
      dot.style.background = `hsl(${Math.floor(Math.random()*360)}, 85%, 60%)`;
      dot.style.zIndex = 9999;
      dot.style.pointerEvents = "none";
      document.body.appendChild(dot);

      const angle = Math.random() * Math.PI * 2;
      const dist = 30 + Math.random() * 40;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist;

      dot.animate([
        { transform: "translate(0,0) scale(1)", opacity: 1 },
        { transform: `translate(${dx}px, ${dy}px) scale(0.9)`, opacity: 0 }
      ], { duration: 380 + Math.random()*220, easing: "cubic-bezier(.2,.8,.2,1)" });

      setTimeout(() => dot.remove(), 700);
    }
  }

  // Sticker breathing opacity
  const sticker = document.getElementById("sticker");
  (function stickerBreath(){
    let t = 0;
    function tick(){
      t += 0.015;
      const a = 0.65 + 0.25 * Math.sin(t);
      sticker.style.opacity = a.toFixed(3);
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  })();

  const el = (id) => document.getElementById(id);

  const quickTabs = el("quickTabs");
  const tabAll = el("tabAll");
  const tabOverdue = el("tabOverdue");
  const tabGrace = el("tabGrace");
  const tabDue7 = el("tabDue7");

  const viewMode = el("viewMode");
  const searchText = el("searchText");
  const clearSearchBtn = el("clearSearchBtn");
  const sortMode = el("sortMode");
  const fakeToday = el("fakeToday");
  const resetTodayBtn = el("resetTodayBtn");

  const kpiPaid = el("kpiPaid");
  const kpiUnpaid = el("kpiUnpaid");
  const kpiExpected = el("kpiExpected");
  const payTable = el("payTable");

  const garageName = el("garageName");
  const addGarageBtn = el("addGarageBtn");
  const garageSelect = el("garageSelect");
  const renameGarageBtn = el("renameGarageBtn");
  const deleteGarageBtn = el("deleteGarageBtn");

  const tenantName = el("tenantName");
  const rentAmount = el("rentAmount");
  const rentDay = el("rentDay");
  const saveSettingsBtn = el("saveSettingsBtn");

  const backupBtn = el("backupBtn");
  const restoreBtn = el("restoreBtn");
  const restoreFile = el("restoreFile");

  const txGarage = el("txGarage");
  const txType = el("txType");
  const txAmount = el("txAmount");
  const txDate = el("txDate");
  const txCategory = el("txCategory");
  const txNote = el("txNote");
  const addTxBtn = el("addTxBtn");

  const filterGarage = el("filterGarage");
  const filterMonth = el("filterMonth");
  const resetFiltersBtn = el("resetFiltersBtn");

  const kpiIncome = el("kpiIncome");
  const kpiExpense = el("kpiExpense");
  const kpiProfit = el("kpiProfit");
  const txTable = el("txTable");

  let state = migrateIfNeeded();

  function getGarage(id) { return state.garages.find(g => g.id === id) || null; }
  function getGarageName(id) { const g = getGarage(id); return g ? g.name : "‚Äî"; }

  function rentPaidSumForPeriod(garageId, periodId) {
    return state.tx
      .filter(t =>
        t.garageId === garageId &&
        t.type === "income" &&
        (t.category || "").toLowerCase().trim() === "–∞—Ä–µ–Ω–¥–∞" &&
        (t.periodId || "") === periodId
      )
      .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
  }

  function statusBadge(kind, text) {
    const span = document.createElement("span");
    span.className = "status " + (kind === "ok" ? "ok" : kind === "soon" ? "soon" : "bad");
    span.textContent = text;
    return span;
  }

  function loadGarageSettingsToForm() {
    const g = getGarage(garageSelect.value);
    if (!g) return;
    tenantName.value = g.tenant || "";
    rentAmount.value = g.rent || "";
    rentDay.value = g.rentDay || 1;
  }

  function getToday() { return fakeToday.value || todayISO(); }

  function refreshSelects() {
    garageSelect.innerHTML = "";
    txGarage.innerHTML = "";
    filterGarage.innerHTML = "";

    state.garages.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.name;
      garageSelect.appendChild(opt);

      const opt2 = document.createElement("option");
      opt2.value = g.id;
      opt2.textContent = g.name;
      txGarage.appendChild(opt2);
    });

    const all = document.createElement("option");
    all.value = "";
    all.textContent = "–í—Å–µ –≥–∞—Ä–∞–∂–∏";
    filterGarage.appendChild(all);
    state.garages.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.name;
      filterGarage.appendChild(opt);
    });

    if (state.garages.length) {
      if (!garageSelect.value) garageSelect.value = state.garages[0].id;
      if (!txGarage.value) txGarage.value = state.garages[0].id;
    }
    loadGarageSettingsToForm();
  }

  function matchesSearch(g, query) {
    if (!query) return true;
    const q = query.toLowerCase().trim();
    if (!q) return true;
    const hay = `${g.name || ""} ${g.tenant || ""}`.toLowerCase();
    return hay.includes(q);
  }

  function setActiveTab(mode) {
    [...quickTabs.querySelectorAll(".tab")].forEach(t => t.classList.remove("active"));
    const map = { all: tabAll, overdue: tabOverdue, grace: tabGrace, due7: tabDue7 };
    (map[mode] || tabAll).classList.add("active");
  }

  function updateTabCounts(cntAll, cntOverdue, cntGrace, cntDue7) {
    tabAll.textContent = `–í—Å–µ (${cntAll})`;
    tabOverdue.textContent = `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (${cntOverdue})`;
    tabGrace.textContent = `–õ—å–≥–æ—Ç–∞ (${cntGrace})`;
    tabDue7.textContent = `–°–∫–æ—Ä–æ (${cntDue7})`;
  }

  function refreshDashboard() {
    const today = getToday();
    const mode = viewMode.value;
    const q = (searchText.value || "").trim();

    let paidCount = 0;
    let unpaidCount = 0;
    let expected = 0;

    let cntOverdue = 0, cntGrace = 0, cntDue7 = 0, cntAll = 0;

    payTable.innerHTML = "";

    let rows = state.garages
      .filter(g => matchesSearch(g, q))
      .map(g => {
        const rent = Number(g.rent || 0);
        const day = Number(g.rentDay || 1);
        const period = calcPeriod(today, day);

        const paidSum = rent > 0 ? rentPaidSumForPeriod(g.id, period.periodId) : 0;
        const debt = Math.max(0, rent - paidSum);
        const fullyPaid = (rent > 0) && (paidSum >= rent);

        const nextStart = dateFromISO(period.startISO);
        const nextDue = addMonths(nextStart, 1);
        const nextDueISO = isoFromDate(nextDue);

        const dleft = daysBetweenISO(today, nextDueISO);
        const daysAfterDue = -dleft;

        const inGrace = (!fullyPaid) && (daysAfterDue > 0 && daysAfterDue <= GRACE_DAYS);
        const overdue = (!fullyPaid) && (daysAfterDue > GRACE_DAYS);
        const dueSoon = (!fullyPaid) && !inGrace && !overdue && (dleft >= 0 && dleft <= 7);

        const overdueDays = overdue ? (daysAfterDue - GRACE_DAYS) : 0;
        const graceLeft = inGrace ? (GRACE_DAYS - daysAfterDue + 1) : 0;

        cntAll++;
        if (overdue) cntOverdue++;
        if (inGrace) cntGrace++;
        if (dueSoon) cntDue7++;

        if (mode === "unpaid" && fullyPaid) return null;
        if (mode === "due7" && !dueSoon) return null;
        if (mode === "overdue" && !overdue) return null;
        if (mode === "grace" && !inGrace) return null;

        if (fullyPaid) paidCount++;
        else unpaidCount++;

        if (!fullyPaid && rent > 0) expected += debt;

        return { g, rent, day, period, fullyPaid, paidSum, debt, dleft, inGrace, overdue, dueSoon, nextDueISO, overdueDays, graceLeft };
      })
      .filter(Boolean);

    updateTabCounts(cntAll, cntOverdue, cntGrace, cntDue7);

    // sorting
    const sm = sortMode.value;
    if (sm === "name") {
      rows.sort((a,b) => a.g.name.localeCompare(b.g.name, "ru"));
    } else if (sm === "nextDue") {
      rows.sort((a,b) => a.nextDueISO.localeCompare(b.nextDueISO) || a.g.name.localeCompare(b.g.name, "ru"));
    } else if (sm === "day128") {
      rows.sort((a,b) => (a.day - b.day) || a.g.name.localeCompare(b.g.name, "ru"));
    } else { // urgent
      rows.sort((a,b) => {
        const bucket = (x) => (x.overdue ? 0 : x.inGrace ? 1 : x.dueSoon ? 2 : 3);
        const ba = bucket(a), bb = bucket(b);
        if (ba !== bb) return ba - bb;

        if (a.overdue && b.overdue) return b.overdueDays - a.overdueDays;
        if (a.inGrace && b.inGrace) return a.graceLeft - b.graceLeft;
        if (a.dueSoon && b.dueSoon) return a.dleft - b.dleft;

        return a.g.name.localeCompare(b.g.name, "ru");
      });
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");

      const who = document.createElement("div");
      who.innerHTML = `<div><b>${r.g.name}</b></div>` +
        `<div class="mini">${(r.g.tenant || "").trim() ? r.g.tenant : "‚Äî –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω"}</div>`;

      const periodLabel = monthNameRuFromISO(r.period.startISO);

      const statusCell = document.createElement("td");
      if (r.rent <= 0) {
        statusCell.appendChild(statusBadge("bad", "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"));
      } else if (r.fullyPaid) {
        statusCell.appendChild(statusBadge("ok", "–û–ø–ª–∞—á–µ–Ω–æ"));
      } else if (r.debt > 0 && r.paidSum > 0) {
        statusCell.appendChild(statusBadge("bad", `–î–æ–ª–≥: ${fmtRub(r.debt)}`));
      } else if (r.overdue) {
        statusCell.appendChild(statusBadge("bad", `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${r.overdueDays} –¥–Ω.`));
      } else if (r.inGrace) {
        statusCell.appendChild(statusBadge("soon", `–õ—å–≥–æ—Ç–∞: –æ—Å—Ç–∞–ª–æ—Å—å ${r.graceLeft} –¥–Ω.`));
      } else if (r.dueSoon) {
        statusCell.appendChild(statusBadge("soon", `–°—Ä–æ–∫ —á–µ—Ä–µ–∑ ${r.dleft} –¥–Ω.`));
      } else {
        statusCell.appendChild(statusBadge("bad", "–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ"));
      }

      const actionCell = document.createElement("td");
      const actions = document.createElement("div");
      actions.className = "actions";

      const payBtn = document.createElement("button");
      payBtn.textContent = "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ";
      payBtn.disabled = r.fullyPaid || r.rent <= 0;
      payBtn.onclick = (ev) => {
        if (r.rent <= 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π —Å—É–º–º—É –∞—Ä–µ–Ω–¥—ã."); return; }
        const amount = Math.max(0, r.rent - r.paidSum);
        if (amount <= 0) { refreshDashboard(); return; }

        const wasDebt = r.debt > 0;

        state.tx.push({
          id: uid(),
          garageId: r.g.id,
          type: "income",
          amount: Math.round(amount),
          date: today,
          category: "–ê—Ä–µ–Ω–¥–∞",
          note: `–ü–µ—Ä–∏–æ–¥ ${r.period.startISO}‚Äì${r.period.endISO} (–∑–∞–∫—Ä—ã—Ç–∏–µ)`,
          periodId: r.period.periodId
        });
        save(state);
        refreshDashboard();
        refreshReport();

        // confetti when debt closed
        if (wasDebt) {
          const rect = ev.target.getBoundingClientRect();
          confettiBurst(rect.left + rect.width/2, rect.top + rect.height/2);
        }
      };

      const partialBtn = document.createElement("button");
      partialBtn.className = "secondary";
      partialBtn.textContent = "üßæ –ß–∞—Å—Ç–∏—á–Ω–æ";
      partialBtn.disabled = r.fullyPaid || r.rent <= 0;
      partialBtn.onclick = (ev) => {
        if (r.rent <= 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π —Å—É–º–º—É –∞—Ä–µ–Ω–¥—ã."); return; }

        const suggested = Math.min(r.debt || r.rent, r.rent).toString();
        const raw = prompt(
          `–°–∫–æ–ª—å–∫–æ –ø—Ä–∏—à–ª–æ? (‚ÇΩ)\n–ê—Ä–µ–Ω–¥–∞: ${fmtRub(r.rent)}\n–£–∂–µ –∑–∞ –ø–µ—Ä–∏–æ–¥: ${fmtRub(r.paidSum)}\n–û—Å—Ç–∞—Ç–æ–∫: ${fmtRub(r.debt)}`,
          suggested
        );
        if (raw === null) return;

        const amt = Math.round(Number(String(raw).replace(",", ".")) || 0);
        if (amt <= 0) { alert("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0."); return; }

        const newSum = r.paidSum + amt;
        if (newSum > r.rent) {
          const over = newSum - r.rent;
          if (!confirm(`–ü–æ–ª—É—á–∏—Ç—Å—è –ø–µ—Ä–µ–ø–ª–∞—Ç–∞ ${fmtRub(over)} –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥.\n–ó–∞—á–µ—Å—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ?`)) return;
        }

        const wasDebt = r.debt > 0;
        const willClose = (newSum >= r.rent);

        state.tx.push({
          id: uid(),
          garageId: r.g.id,
          type: "income",
          amount: Math.round(amt),
          date: today,
          category: "–ê—Ä–µ–Ω–¥–∞",
          note: `–ü–µ—Ä–∏–æ–¥ ${r.period.startISO}‚Äì${r.period.endISO} (—á–∞—Å—Ç–∏—á–Ω–æ)`,
          periodId: r.period.periodId
        });
        save(state);
        refreshDashboard();
        refreshReport();

        if (wasDebt && willClose) {
          const rect = ev.target.getBoundingClientRect();
          confettiBurst(rect.left + rect.width/2, rect.top + rect.height/2);
        }
      };

      const settingsBtn = document.createElement("button");
      settingsBtn.className = "secondary";
      settingsBtn.textContent = "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å";
      settingsBtn.onclick = () => {
        garageSelect.value = r.g.id;
        loadGarageSettingsToForm();
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      actions.appendChild(payBtn);
      actions.appendChild(partialBtn);
      actions.appendChild(settingsBtn);
      actionCell.appendChild(actions);

      tr.innerHTML = `
        <td></td>
        <td class="nowrap">${r.day || "‚Äî"}</td>
        <td>
          <div><b>${periodLabel}</b></div>
          <div class="mini">${r.period.startISO}‚Äì${r.period.endISO}</div>
          ${r.paidSum > 0 && !r.fullyPaid ? `<div class="mini">–û–ø–ª–∞—á–µ–Ω–æ: ${fmtRub(r.paidSum)}</div>` : ""}
        </td>
        <td class="nowrap">${r.rent ? fmtRub(r.rent) : "‚Äî"}</td>
        <td></td>
        <td class="nowrap"></td>
      `;

      tr.children[0].appendChild(who);
      tr.children[4].replaceWith(statusCell);
      tr.children[5].replaceWith(actionCell);

      payTable.appendChild(tr);
    });

    kpiPaid.textContent = String(paidCount);
    kpiUnpaid.textContent = String(unpaidCount);
    kpiExpected.textContent = fmtRub(expected);
  }

  function applyFiltersTx(tx) {
    let res = [...tx];
    const g = filterGarage.value;
    const m = filterMonth.value;
    if (g) res = res.filter(t => t.garageId === g);
    if (m) res = res.filter(t => (t.date || "").slice(0,7) === m);
    res.sort((a,b) => (b.date || "").localeCompare(a.date || ""));
    return res;
  }

  function refreshReport() {
    const rows = applyFiltersTx(state.tx);

    let inc = 0, exp = 0;
    rows.forEach(t => {
      const amt = Number(t.amount) || 0;
      if (t.type === "income") inc += amt;
      else exp += amt;
    });

    kpiIncome.textContent = fmtRub(inc);
    kpiExpense.textContent = fmtRub(exp);

    const profit = inc - exp;
    kpiProfit.textContent = fmtRub(profit);
    kpiProfit.classList.toggle("good", profit > 0);
    kpiProfit.classList.toggle("bad", profit < 0);

    txTable.innerHTML = "";
    rows.forEach(t => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.date || "‚Äî"}</td>
        <td>${getGarageName(t.garageId)}</td>
        <td>${t.type === "income" ? "–î–æ—Ö–æ–¥" : "–†–∞—Å—Ö–æ–¥"}</td>
        <td>${(t.category || "").trim() || "‚Äî"}</td>
        <td>${fmtRub(t.amount)}</td>
        <td>${(t.note || "").trim() || "‚Äî"}</td>
        <td></td>
      `;
      const delBtn = document.createElement("button");
      delBtn.className = "secondary";
      delBtn.textContent = "üóëÔ∏è";
      delBtn.title = "–£–¥–∞–ª–∏—Ç—å";
      delBtn.onclick = () => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?")) return;
        state.tx = state.tx.filter(x => x.id !== t.id);
        save(state);
        refreshReport();
        refreshDashboard();
      };
      tr.children[6].appendChild(delBtn);
      txTable.appendChild(tr);
    });
  }

  // Backup / Restore
  function downloadText(filename, text) {
    const blob = new Blob([text], { type: "application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }

  function doBackup() {
    const month = monthKey(todayISO());
    const filename = `garage-backup-${month}.json`;
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      data: state
    };
    downloadText(filename, JSON.stringify(payload, null, 2));
    localStorage.setItem(LAST_BACKUP_KEY, month);
    alert("–ë—ç–∫–∞–ø —Å–∫–∞—á–∞–Ω. –û—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª –≤ Telegram ‚Üí –ò–∑–±—Ä–∞–Ω–Ω–æ–µ.");
  }

  function doRestoreFromObject(obj) {
    if (!obj) { alert("–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –±–∏—Ç—ã–π."); return; }
    const data = obj.data && obj.data.garages ? obj.data : (obj.garages ? obj : null);
    if (!data || !Array.isArray(data.garages) || !Array.isArray(data.tx)) {
      alert("–ù–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –±—ç–∫–∞–ø —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.");
      return;
    }
    if (!confirm("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—ç–∫–∞–ø–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.")) return;

    state = {
      garages: data.garages.map(g => ({
        id: g.id || uid(),
        name: g.name || "–ì–∞—Ä–∞–∂",
        rent: Number(g.rent || 0),
        rentDay: Number(g.rentDay || 1),
        tenant: g.tenant || ""
      })),
      tx: data.tx.map(t => ({
        id: t.id || uid(),
        garageId: t.garageId,
        type: t.type,
        amount: Number(t.amount || 0),
        date: t.date,
        category: t.category || "",
        note: t.note || "",
        periodId: t.periodId || ""
      }))
    };

    save(state);
    refreshSelects();
    refreshDashboard();
    refreshReport();
    alert("–ì–æ—Ç–æ–≤–æ. –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.");
  }

  function maybeMonthlyBackupReminder() {
    const nowMonth = monthKey(todayISO());
    const last = localStorage.getItem(LAST_BACKUP_KEY) || "";
    if (last !== nowMonth) {
      // show once per month on open
      setTimeout(() => {
        alert("‚ö†Ô∏è –ü—Ä–æ—à—ë–ª –º–µ—Å—è—Ü. –°–¥–µ–ª–∞–π —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∏ –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª –≤ Telegram ‚Üí –ò–∑–±—Ä–∞–Ω–Ω–æ–µ.");
      }, 600);
    }
  }

  // Events
  addGarageBtn.onclick = () => {
    const name = (garageName.value || "").trim();
    if (!name) { alert("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞."); return; }
    state.garages.push({ id: uid(), name, rent: 0, rentDay: 1, tenant: "" });
    garageName.value = "";
    save(state);
    refreshSelects();
    refreshDashboard();
    refreshReport();
  };

  garageSelect.onchange = loadGarageSettingsToForm;

  renameGarageBtn.onclick = () => {
    const g = getGarage(garageSelect.value);
    if (!g) return;
    const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞:", g.name);
    if (!name) return;
    g.name = name.trim();
    save(state);
    refreshSelects();
    refreshDashboard();
    refreshReport();
  };

  deleteGarageBtn.onclick = () => {
    const g = getGarage(garageSelect.value);
    if (!g) return;
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${g.name}" –∏ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –Ω–µ–º—É?`)) return;
    state.garages = state.garages.filter(x => x.id !== g.id);
    state.tx = state.tx.filter(t => t.garageId !== g.id);
    save(state);
    refreshSelects();
    refreshDashboard();
    refreshReport();
  };

  saveSettingsBtn.onclick = () => {
    const g = getGarage(garageSelect.value);
    if (!g) return;

    const rent = Math.round(Number(rentAmount.value) || 0);
    const day = Math.round(Number(rentDay.value) || 1);
    const tenant = (tenantName.value || "").trim();

    if (rent < 0) { alert("–°—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π."); return; }
    if (day < 1 || day > 28) { alert("–î–µ–Ω—å –æ–ø–ª–∞—Ç—ã: 1‚Äì28."); return; }

    g.rent = rent;
    g.rentDay = day;
    g.tenant = tenant;

    save(state);
    refreshDashboard();
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
  };

  backupBtn.onclick = doBackup;
  restoreBtn.onclick = () => restoreFile.click();
  restoreFile.onchange = async () => {
    const f = restoreFile.files && restoreFile.files[0];
    if (!f) return;
    const text = await f.text();
    const obj = parseJSON(text);
    doRestoreFromObject(obj);
    restoreFile.value = "";
  };

  quickTabs.addEventListener("click", (e) => {
    const tab = e.target.closest(".tab");
    if (!tab) return;
    const mode = tab.dataset.mode;
    viewMode.value = mode;
    setActiveTab(mode);
    refreshDashboard();
  });

  viewMode.onchange = () => {
    setActiveTab(viewMode.value);
    refreshDashboard();
  };

  sortMode.onchange = refreshDashboard;
  fakeToday.onchange = refreshDashboard;
  resetTodayBtn.onclick = () => { fakeToday.value = todayISO(); refreshDashboard(); };

  let searchTimer = null;
  searchText.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(refreshDashboard, 120);
  });

  clearSearchBtn.onclick = () => {
    searchText.value = "";
    refreshDashboard();
    searchText.focus();
  };

  addTxBtn.onclick = () => {
    const garageId = txGarage.value;
    if (!garageId) { alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –≥–∞—Ä–∞–∂."); return; }

    const type = txType.value;
    const amount = Number(txAmount.value);
    const date = txDate.value;
    const category = (txCategory.value || "").trim();
    const note = (txNote.value || "").trim();

    if (!date) { alert("–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É."); return; }
    if (!Number.isFinite(amount) || amount <= 0) { alert("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0."); return; }

    state.tx.push({ id: uid(), garageId, type, amount: Math.round(amount), date, category, note, periodId: "" });
    txAmount.value = ""; txCategory.value = ""; txNote.value = "";
    save(state);
    refreshReport();
    refreshDashboard();
  };

  filterGarage.onchange = refreshReport;
  filterMonth.onchange = refreshReport;
  resetFiltersBtn.onclick = () => {
    filterGarage.value = "";
    filterMonth.value = monthKey(todayISO());
    refreshReport();
  };

  // init
  fakeToday.value = todayISO();
  txDate.value = todayISO();
  filterMonth.value = monthKey(todayISO());

  refreshSelects();
  setActiveTab("all");
  refreshDashboard();
  refreshReport();
  maybeMonthlyBackupReminder();
</script>
</body>
</html>
