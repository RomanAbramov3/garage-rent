<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–£—á–µ—Ç –∞—Ä–µ–Ω–¥—ã –≥–∞—Ä–∞–∂–µ–π</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .grid { display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    .card { background:#fff; border:1px solid #e6e8ef; border-radius:14px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    h1 { margin: 0 0 10px; font-size: 22px; }
    h2 { margin: 0 0 10px; font-size: 16px; }
    label { display:block; font-size: 12px; color:#555; margin: 10px 0 6px; }
    input, select, button, textarea { width:100%; box-sizing: border-box; padding:10px; border-radius:10px; border:1px solid #d7dbe6; background:#fff; }
    textarea { resize: vertical; min-height: 44px; }
    button { cursor:pointer; border:0; background:#1a73e8; color:#fff; font-weight:600; }
    button.secondary { background:#eef2ff; color:#1f2a44; border:1px solid #d7dbe6; }
    button.danger { background:#ffe9e9; color:#7a0610; border:1px solid #f5b5b5; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .kpi { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .kpi .box { padding:12px; border-radius:12px; border:1px solid #e6e8ef; background:#fbfcff; }
    .kpi .name { font-size: 12px; color:#555; }
    .kpi .val { font-size: 18px; font-weight: 750; margin-top: 4px; }
    .val.good { color:#0b7a34; }
    .val.bad { color:#b42318; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #eef0f6; text-align:left; font-size: 13px; }
    th { font-size: 12px; color:#555; font-weight: 650; }
    .tag { display:inline-block; padding:3px 8px; border-radius:999px; font-size: 12px; border:1px solid #e6e8ef; }
    .tag.in { background:#eaf6ee; border-color:#bfe7cd; }
    .tag.out { background:#fdecec; border-color:#f7b4b4; }
    .muted { color:#666; font-size: 12px; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #e6e8ef; background:#fbfcff; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>–£—á–µ—Ç –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∞—Ä–µ–Ω–¥–µ –≥–∞—Ä–∞–∂–µ–π</h1>

    <div class="grid">
      <div class="card">
        <h2>–ì–∞—Ä–∞–∂–∏</h2>

        <div class="row">
          <div>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞</label>
            <input id="garageName" placeholder="–ù–∞–ø—Ä. –ì–∞—Ä–∞–∂ #1 (–ö—Ä—ã—à–∞ –Ω–æ–≤–∞—è)" />
          </div>
          <div style="align-self:end;">
            <button id="addGarageBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </div>

        <label>–°–ø–∏—Å–æ–∫ –≥–∞—Ä–∞–∂–µ–π</label>
        <select id="garageList" size="6"></select>

        <div class="row" style="margin-top:10px;">
          <button class="secondary" id="renameGarageBtn">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
          <button class="danger" id="deleteGarageBtn">–£–¥–∞–ª–∏—Ç—å</button>
        </div>

        <hr style="margin:14px 0; border:none; border-top:1px solid #eef0f6;" />

        <h2>–ê—Ä–µ–Ω–¥–∞ ‚Äú–≤ –æ–¥–∏–Ω –∫–ª–∏–∫‚Äù</h2>
        <p class="muted" style="margin:0 0 8px;">
          –í—ã–±–∏—Ä–∞–µ—à—å –≥–∞—Ä–∞–∂ ‚Üí –∑–∞–¥–∞—ë—à—å –∞—Ä–µ–Ω–¥—É –≤ –º–µ—Å—è—Ü ‚Üí –ø–æ—Ç–æ–º —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –∂–º—ë—à—å –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É.
        </p>

        <label>–ì–∞—Ä–∞–∂ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
        <select id="rentGarage"></select>

        <div class="row">
          <div>
            <label>–ê—Ä–µ–Ω–¥–∞ –≤ –º–µ—Å—è—Ü (‚ÇΩ)</label>
            <input id="rentAmount" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä. 6000" />
          </div>
          <div style="align-self:end;">
            <button class="secondary" id="saveRentBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <div class="pill" id="rentStatus">–ê—Ä–µ–Ω–¥–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞</div>
          </div>
          <div style="align-self:end;">
            <button id="oneClickPayBtn">–ó–∞—á–µ—Å—Ç—å –∞—Ä–µ–Ω–¥—É –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</button>
          </div>
        </div>

        <p class="muted" style="margin:10px 0 0;">
          –ö–Ω–æ–ø–∫–∞ –Ω–µ –¥–∞—Å—Ç –∑–∞—á–µ—Å—Ç—å –∞—Ä–µ–Ω–¥—É –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –∑–∞ —Ç–æ—Ç –∂–µ –º–µ—Å—è—Ü. (–ó–∞—â–∏—Ç–∞ –æ—Ç ‚Äú—Å–∞–º —Å–µ–±–µ –∑–∞–ø–ª–∞—Ç–∏–ª –¥–≤–∞–∂–¥—ã‚Äù.)
        </p>
      </div>

      <div class="card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é</h2>

        <label>–ì–∞—Ä–∞–∂</label>
        <select id="txGarage"></select>

        <div class="row">
          <div>
            <label>–¢–∏–ø</label>
            <select id="txType">
              <option value="income">–î–æ—Ö–æ–¥</option>
              <option value="expense">–†–∞—Å—Ö–æ–¥</option>
            </select>
          </div>
          <div>
            <label>–°—É–º–º–∞ (‚ÇΩ)</label>
            <input id="txAmount" type="number" min="0" step="1" placeholder="–ù–∞–ø—Ä. 12500" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>–î–∞—Ç–∞</label>
            <input id="txDate" type="date" />
          </div>
          <div>
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <input id="txCategory" placeholder="–ê—Ä–µ–Ω–¥–∞ / –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ / –†–µ–º–æ–Ω—Ç..." />
          </div>
        </div>

        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="txNote" placeholder="–ù–∞–ø—Ä. –æ–ø–ª–∞—Ç–∞ –∑–∞ —è–Ω–≤–∞—Ä—å / –∑–∞–º–µ–Ω–∞ –∑–∞–º–∫–∞"></textarea>

        <div style="margin-top:10px;">
          <button id="addTxBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>–û—Ç—á–µ—Ç</h2>

      <div class="row">
        <div>
          <label>–§–∏–ª—å—Ç—Ä: –≥–∞—Ä–∞–∂</label>
          <select id="filterGarage"></select>
        </div>
        <div>
          <label>–§–∏–ª—å—Ç—Ä: –º–µ—Å—è—Ü</label>
          <input id="filterMonth" type="month" />
        </div>
        <div style="align-self:end;">
          <button class="secondary" id="resetFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px;">
        <div class="box">
          <div class="name">–î–æ—Ö–æ–¥</div>
          <div class="val good" id="kpiIncome">0 ‚ÇΩ</div>
        </div>
        <div class="box">
          <div class="name">–†–∞—Å—Ö–æ–¥</div>
          <div class="val bad" id="kpiExpense">0 ‚ÇΩ</div>
        </div>
        <div class="box">
          <div class="name">–ü—Ä–∏–±—ã–ª—å</div>
          <div class="val" id="kpiProfit">0 ‚ÇΩ</div>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–ì–∞—Ä–∞–∂</th>
              <th>–¢–∏–ø</th>
              <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
              <th>–°—É–º–º–∞</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ï—Å–ª–∏ –ø–æ—á–∏—Å—Ç–∏—à—å –¥–∞–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä–∞ ‚Äî —É–ª–µ—Ç–∏—Ç –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º–∏, –∫–∞–∫ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã –≤–µ—Å–Ω–æ–π üôÇ
      </p>
    </div>
  </div>

<script>
  const KEY = "garage_rent_v2";

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function migrateIfNeeded(state) {
    // –ü–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ v1 (–µ—Å–ª–∏ –±—ã–ª–∏)
    const old = localStorage.getItem("garage_rent_v1");
    if (old && (!state || !state.garages)) {
      try {
        const v1 = JSON.parse(old);
        const migrated = {
          garages: (v1.garages || []).map(g => ({ id: g.id || uid(), name: g.name || "–ì–∞—Ä–∞–∂", rent: g.rent || 0 })),
          tx: (v1.tx || []).map(t => ({ ...t, id: t.id || uid() }))
        };
        localStorage.setItem(KEY, JSON.stringify(migrated));
        return migrated;
      } catch (e) {}
    }
    return state;
  }

  function load() {
    const raw = localStorage.getItem(KEY);
    if (!raw) {
      const init = { garages: [{ id: uid(), name: "–ì–∞—Ä–∞–∂ #1", rent: 0 }], tx: [] };
      localStorage.setItem(KEY, JSON.stringify(init));
      return init;
    }
    try {
      const st = JSON.parse(raw);
      return migrateIfNeeded(st);
    } catch(e) {
      return { garages: [], tx: [] };
    }
  }

  function save(state) {
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function fmtRub(n) {
    const x = Math.round(Number(n) || 0);
    return x.toLocaleString("ru-RU") + " ‚ÇΩ";
  }

  function todayISO() {
    const d = new Date();
    const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return tz.toISOString().slice(0,10);
  }

  function monthKey(isoDate) { // "YYYY-MM"
    return (isoDate || "").slice(0,7);
  }

  const el = (id) => document.getElementById(id);

  const garageName = el("garageName");
  const addGarageBtn = el("addGarageBtn");
  const garageList = el("garageList");
  const renameGarageBtn = el("renameGarageBtn");
  const deleteGarageBtn = el("deleteGarageBtn");

  const rentGarage = el("rentGarage");
  const rentAmount = el("rentAmount");
  const saveRentBtn = el("saveRentBtn");
  const rentStatus = el("rentStatus");
  const oneClickPayBtn = el("oneClickPayBtn");

  const txGarage = el("txGarage");
  const txType = el("txType");
  const txAmount = el("txAmount");
  const txDate = el("txDate");
  const txCategory = el("txCategory");
  const txNote = el("txNote");
  const addTxBtn = el("addTxBtn");

  const filterGarage = el("filterGarage");
  const filterMonth = el("filterMonth");
  const resetFiltersBtn = el("resetFiltersBtn");

  const kpiIncome = el("kpiIncome");
  const kpiExpense = el("kpiExpense");
  const kpiProfit = el("kpiProfit");

  const txTable = el("txTable");

  let state = load();

  function getGarage(id) {
    return state.garages.find(x => x.id === id) || null;
  }

  function getGarageName(id) {
    const g = getGarage(id);
    return g ? g.name : "‚Äî";
  }

  function hasRentPaymentForMonth(garageId, ym) {
    return state.tx.some(t =>
      t.garageId === garageId &&
      t.type === "income" &&
      (t.category || "").toLowerCase().trim() === "–∞—Ä–µ–Ω–¥–∞" &&
      monthKey(t.date) === ym
    );
  }

  function refreshOneClickUI() {
    const gid = rentGarage.value;
    const g = getGarage(gid);

    if (!g) {
      rentStatus.textContent = "–ì–∞—Ä–∞–∂ –Ω–µ –≤—ã–±—Ä–∞–Ω";
      oneClickPayBtn.disabled = true;
      return;
    }

    const rent = Number(g.rent || 0);
    const ym = filterMonth.value || monthKey(todayISO());

    if (!rent || rent <= 0) {
      rentStatus.textContent = "–ê—Ä–µ–Ω–¥–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞";
      oneClickPayBtn.disabled = true;
      oneClickPayBtn.textContent = "–ó–∞—á–µ—Å—Ç—å –∞—Ä–µ–Ω–¥—É –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü";
      return;
    }

    const already = hasRentPaymentForMonth(gid, ym);
    rentStatus.textContent = `–ê—Ä–µ–Ω–¥–∞: ${fmtRub(rent)} / –º–µ—Å`;

    if (already) {
      oneClickPayBtn.disabled = true;
      oneClickPayBtn.textContent = "–£–∂–µ –∑–∞—á—Ç–µ–Ω–æ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü";
    } else {
      oneClickPayBtn.disabled = false;
      oneClickPayBtn.textContent = `–ó–∞—á–µ—Å—Ç—å –∞—Ä–µ–Ω–¥—É –∑–∞ ${ym}`;
    }
  }

  function refreshGarageSelects() {
    garageList.innerHTML = "";
    rentGarage.innerHTML = "";
    txGarage.innerHTML = "";
    filterGarage.innerHTML = "";

    state.garages.forEach(g => {
      const opt1 = document.createElement("option");
      opt1.value = g.id;
      opt1.textContent = g.name;
      garageList.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = g.id;
      opt2.textContent = g.name;
      rentGarage.appendChild(opt2);

      const opt3 = document.createElement("option");
      opt3.value = g.id;
      opt3.textContent = g.name;
      txGarage.appendChild(opt3);
    });

    const all = document.createElement("option");
    all.value = "";
    all.textContent = "–í—Å–µ –≥–∞—Ä–∞–∂–∏";
    filterGarage.appendChild(all);
    state.garages.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.name;
      filterGarage.appendChild(opt);
    });

    if (state.garages.length) {
      if (!garageList.value) garageList.value = state.garages[0].id;
      if (!txGarage.value) txGarage.value = state.garages[0].id;
      if (!rentGarage.value) rentGarage.value = state.garages[0].id;
    }

    // –ø–æ–¥—Å—Ç–∞–≤–∏–º rentAmount –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –≥–∞—Ä–∞–∂—É
    const g = getGarage(rentGarage.value);
    rentAmount.value = g ? (g.rent || "") : "";
    refreshOneClickUI();
  }

  function applyFilters(tx) {
    let res = [...tx];
    const g = filterGarage.value;
    const m = filterMonth.value; // YYYY-MM
    if (g) res = res.filter(t => t.garageId === g);
    if (m) res = res.filter(t => (t.date || "").slice(0,7) === m);
    res.sort((a,b) => (b.date || "").localeCompare(a.date || ""));
    return res;
  }

  function refreshReport() {
    const rows = applyFilters(state.tx);

    let inc = 0, exp = 0;
    rows.forEach(t => {
      const amt = Number(t.amount) || 0;
      if (t.type === "income") inc += amt;
      else exp += amt;
    });

    kpiIncome.textContent = fmtRub(inc);
    kpiExpense.textContent = fmtRub(exp);

    const profit = inc - exp;
    kpiProfit.textContent = fmtRub(profit);
    kpiProfit.classList.toggle("good", profit > 0);
    kpiProfit.classList.toggle("bad", profit < 0);

    txTable.innerHTML = "";
    rows.forEach(t => {
      const tr = document.createElement("tr");

      const typeTag = document.createElement("span");
      typeTag.className = "tag " + (t.type === "income" ? "in" : "out");
      typeTag.textContent = t.type === "income" ? "–î–æ—Ö–æ–¥" : "–†–∞—Å—Ö–æ–¥";

      tr.innerHTML = `
        <td>${t.date || "‚Äî"}</td>
        <td>${getGarageName(t.garageId)}</td>
        <td></td>
        <td>${(t.category || "").trim() || "‚Äî"}</td>
        <td>${fmtRub(t.amount)}</td>
        <td>${(t.note || "").trim() || "‚Äî"}</td>
        <td></td>
      `;
      tr.children[2].appendChild(typeTag);

      const delBtn = document.createElement("button");
      delBtn.className = "secondary";
      delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
      delBtn.onclick = () => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?")) return;
        state.tx = state.tx.filter(x => x.id !== t.id);
        save(state);
        refreshReport();
        refreshOneClickUI();
      };
      tr.children[6].appendChild(delBtn);

      txTable.appendChild(tr);
    });

    refreshOneClickUI();
  }

  // –≥–∞—Ä–∞–∂–∏
  addGarageBtn.onclick = () => {
    const name = (garageName.value || "").trim();
    if (!name) { alert("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞."); return; }
    state.garages.push({ id: uid(), name, rent: 0 });
    garageName.value = "";
    save(state);
    refreshGarageSelects();
    refreshReport();
  };

  renameGarageBtn.onclick = () => {
    const id = garageList.value;
    if (!id) { alert("–í—ã–±–µ—Ä–∏ –≥–∞—Ä–∞–∂."); return; }
    const g = getGarage(id);
    const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–∞—Ä–∞–∂–∞:", g ? g.name : "");
    if (!name) return;
    g.name = name.trim();
    save(state);
    refreshGarageSelects();
    refreshReport();
  };

  deleteGarageBtn.onclick = () => {
    const id = garageList.value;
    if (!id) { alert("–í—ã–±–µ—Ä–∏ –≥–∞—Ä–∞–∂."); return; }
    const gname = getGarageName(id);
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${gname}" –∏ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –Ω–µ–º—É?`)) return;
    state.garages = state.garages.filter(g => g.id !== id);
    state.tx = state.tx.filter(t => t.garageId !== id);
    save(state);
    refreshGarageSelects();
    refreshReport();
  };

  // –∞—Ä–µ–Ω–¥–∞ –≤ –æ–¥–∏–Ω –∫–ª–∏–∫
  rentGarage.onchange = () => {
    const g = getGarage(rentGarage.value);
    rentAmount.value = g ? (g.rent || "") : "";
    refreshOneClickUI();
  };

  saveRentBtn.onclick = () => {
    const gid = rentGarage.value;
    const g = getGarage(gid);
    if (!g) { alert("–í—ã–±–µ—Ä–∏ –≥–∞—Ä–∞–∂."); return; }

    const amt = Math.round(Number(rentAmount.value) || 0);
    if (amt <= 0) { alert("–ê—Ä–µ–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0."); return; }

    g.rent = amt;
    save(state);
    refreshOneClickUI();
    alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${g.name} = ${fmtRub(amt)} / –º–µ—Å—è—Ü`);
  };

  oneClickPayBtn.onclick = () => {
    const gid = rentGarage.value;
    const g = getGarage(gid);
    if (!g) { alert("–í—ã–±–µ—Ä–∏ –≥–∞—Ä–∞–∂."); return; }

    const rent = Number(g.rent || 0);
    if (!rent || rent <= 0) { alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π –∞—Ä–µ–Ω–¥—É –≤ –º–µ—Å—è—Ü."); return; }

    const ym = filterMonth.value || monthKey(todayISO());
    if (hasRentPaymentForMonth(gid, ym)) {
      alert("–ó–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü —É–∂–µ –∑–∞—á—Ç–µ–Ω–æ.");
      refreshOneClickUI();
      return;
    }

    const date = todayISO();
    state.tx.push({
      id: uid(),
      garageId: gid,
      type: "income",
      amount: Math.round(rent),
      date,
      category: "–ê—Ä–µ–Ω–¥–∞",
      note: `–û–ø–ª–∞—Ç–∞ –∑–∞ ${ym}`
    });

    save(state);
    refreshReport();
  };

  // —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  addTxBtn.onclick = () => {
    const garageId = txGarage.value;
    if (!garageId) { alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–∞—Ä–∞–∂."); return; }

    const type = txType.value;
    const amount = Number(txAmount.value);
    const date = txDate.value;
    const category = (txCategory.value || "").trim();
    const note = (txNote.value || "").trim();

    if (!date) { alert("–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É."); return; }
    if (!Number.isFinite(amount) || amount <= 0) { alert("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0."); return; }

    state.tx.push({
      id: uid(),
      garageId,
      type,
      amount: Math.round(amount),
      date,
      category,
      note
    });

    txAmount.value = "";
    txCategory.value = "";
    txNote.value = "";
    save(state);
    refreshReport();
  };

  // —Ñ–∏–ª—å—Ç—Ä—ã
  filterGarage.onchange = refreshReport;
  filterMonth.onchange = () => { refreshReport(); refreshOneClickUI(); };
  resetFiltersBtn.onclick = () => {
    filterGarage.value = "";
    filterMonth.value = monthKey(todayISO());
    refreshReport();
  };

  // init
  txDate.value = todayISO();
  filterMonth.value = monthKey(todayISO());

  refreshGarageSelects();
  refreshReport();
</script>
</body>
</html>
